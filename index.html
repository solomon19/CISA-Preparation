<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#090e17">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CISA D1: Info System Auditing Process</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #050810;
            --bg-card: #111827;
            --bg-card-elevated: #1e293b;
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.5);
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header (Fixed) --- */
        header {
            background: rgba(5, 8, 16, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: max(15px, env(safe-area-inset-top)) 20px 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; z-index: 50;
        }
        .logo { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 12px; line-height: 1.2;}
        .logo .icon-box { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px var(--primary-glow); color: white; font-size: 1.1rem; flex-shrink: 0;
        }
        .logo-text span { display: block; font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;}

        .streak-badge { 
            display: flex; align-items: center; gap: 6px; font-size: 0.95rem; font-weight: 800; color: #f97316; 
            background: rgba(249, 115, 22, 0.1); padding: 8px 14px; border-radius: 12px; border: 1px solid rgba(249, 115, 22, 0.2);
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.1);
        }

        /* --- Main Scrollable Area --- */
        .main-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px 20px calc(30px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
        }
        .main-content::-webkit-scrollbar { display: none; }

        .view { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Components --- */
        h2.section-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 10px; }
        h2.section-title i { color: var(--primary); }
        
        .card { 
            background: var(--bg-card); border: 1px solid var(--border); 
            border-radius: var(--radius-lg); padding: 24px; margin-bottom: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        /* --- Premium Dashboard Journey --- */
        .mastery-header { text-align: center; margin-bottom: 25px; }
        .mastery-header h3 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .mastery-header p { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .journey-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .j-box { background: var(--bg-card-elevated); padding: 15px 10px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .j-box h4 { font-size: 1.6rem; font-weight: 800; margin-bottom: 5px; }
        .j-box span { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        
        .j-mastered h4 { color: var(--success); text-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .j-lost h4 { color: var(--danger); text-shadow: 0 0 15px rgba(244, 63, 94, 0.4); }
        .j-untouched h4 { color: var(--primary); text-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        .progress-track { width: 100%; height: 14px; background: rgba(255,255,255,0.05); border-radius: 20px; display: flex; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        .track-mastered { background: linear-gradient(90deg, #059669, #10b981); transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); }
        .track-lost { background: linear-gradient(90deg, #e11d48, #f43f5e); transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); }

        /* --- Circular Progress --- */
        .svg-progress-container { display: flex; justify-content: center; align-items: center; position: relative; width: 140px; height: 140px; margin: 0 auto 15px auto; }
        .svg-progress { width: 100%; height: 100%; transform: rotate(-90deg); }
        .svg-bg { fill: none; stroke: var(--border); stroke-width: 8; }
        .svg-fill { fill: none; stroke: url(#gradient); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 400; stroke-dashoffset: 400; transition: stroke-dashoffset 1s cubic-bezier(0.16, 1, 0.3, 1); }
        .svg-progress-text { position: absolute; text-align: center; }
        .svg-progress-text h3 { font-size: 2.2rem; font-weight: 800; margin: 0; line-height: 1; }
        .svg-progress-text span { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* --- Linear Progress --- */
        .progress-container { margin-bottom: 18px; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; font-weight: 600; }
        .progress-header .domain-name { color: var(--text-main); }
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); border-radius: 10px; }

        /* --- Deep Lessons Scroller (Dashboard) --- */
        .lessons-scroller {
            display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; margin-bottom: 10px;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .lessons-scroller::-webkit-scrollbar { display: none; }
        .lesson-card { 
            background: linear-gradient(145deg, var(--bg-card-elevated), var(--bg-card)); 
            border: 1px solid var(--border); padding: 20px; border-radius: var(--radius-md); 
            min-width: 280px; scroll-snap-align: start; flex-shrink: 0; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s;
        }
        .lesson-card:active { transform: scale(0.97); }
        .lesson-card i.watermark { position: absolute; right: -15px; bottom: -15px; font-size: 6rem; opacity: 0.03; color: white; pointer-events: none; }
        .lesson-card h4 { color: var(--primary); font-size: 1.05rem; font-weight: 800; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;}
        .lesson-card ul { margin: 0; padding-left: 20px; color: var(--text-main); font-size: 0.9rem; line-height: 1.6; pointer-events: none; }
        .lesson-card li { margin-bottom: 8px; }
        .lesson-card li strong { color: var(--secondary); }
        .tap-to-read { position: absolute; top: 15px; right: 15px; font-size: 0.7rem; color: var(--text-muted); background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 20px; font-weight: bold;}

        /* --- Quick Play Grid --- */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; margin-bottom: 20px; perspective: 1000px; }
        .grid-item {
            aspect-ratio: 1; background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px);
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 0.95rem; font-weight: 700; color: #e2e8f0;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .grid-item:active { transform: scale(0.85); }
        .grid-item.mastered { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: rgba(16, 185, 129, 0.5); }
        .grid-item.lost { background: rgba(244, 63, 94, 0.2); color: var(--danger); border-color: rgba(244, 63, 94, 0.5); }
        .grid-item.highlight { 
            border-color: var(--secondary); color: white; 
            transform: scale(1.25) translateZ(10px); z-index: 10; 
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            box-shadow: 0 0 20px var(--secondary), 0 0 10px var(--primary);
        }

        /* --- Buttons --- */
        .btn-main {
            width: 100%; background: var(--primary); color: white; border: none; padding: 18px;
            border-radius: var(--radius-md); font-size: 1.05rem; font-weight: 700; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px var(--primary-glow); transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }
        .btn-main.danger { background: transparent; border: 1px solid rgba(244, 63, 94, 0.3); color: var(--danger); box-shadow: none; padding: 15px;}
        .btn-main.danger:active { background: rgba(244, 63, 94, 0.1); }
        .btn-main.success { background: var(--success); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }

        .btn-spin-grid {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white; border: none; padding: 16px; border-radius: 50px; width: 100%;
            font-size: 1.1rem; font-weight: 800; cursor: pointer; margin-bottom: 25px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 8px 25px var(--primary-glow); transition: 0.3s; position: relative; overflow: hidden;
        }
        .btn-spin-grid:active { transform: scale(0.96); }
        .btn-spin-grid::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg); animation: gridShine 3s infinite;
        }
        @keyframes gridShine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        /* --- Simulator Menu --- */
        .mode-btn {
            width: 100%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);
            padding: 20px; border-radius: var(--radius-md); margin-bottom: 15px; text-align: left; 
            cursor: pointer; display: flex; flex-direction: column; gap: 8px; transition: 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .mode-btn:active { transform: scale(0.98); border-color: var(--primary); }
        .mode-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .mode-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

        /* --- Quiz Engine Active UI --- */
        .quiz-container { display: none; }
        .quiz-container.active { display: block; }
        .quiz-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .quiz-timer { font-size: 0.95rem; font-weight: 700; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .quiz-timer.urgent { color: var(--danger); animation: pulseRed 1s infinite; }
        @keyframes pulseRed { 50% { opacity: 0.5; } }
        .quiz-counter { background: rgba(255,255,255,0.08); padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; }
        
        .topic-tag { display: inline-block; font-size: 0.75rem; color: var(--secondary); background: rgba(99, 102, 241, 0.15); padding: 6px 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;}
        
        .mindset-alert { 
            display: none; background: rgba(245, 158, 11, 0.15); border: 1px solid var(--warning); 
            color: var(--warning); padding: 12px 15px; border-radius: 12px; font-size: 0.9rem; font-weight: 700; 
            margin-bottom: 20px; align-items: center; gap: 10px; animation: slideUp 0.3s;
        }

        .q-text { font-size: 1.15rem; line-height: 1.6; margin-bottom: 25px; font-weight: 600; color: white; }
        
        .option-btn {
            width: 100%; background: var(--bg-deep); border: 2px solid var(--border); color: var(--text-main);
            padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; text-align: left; font-size: 0.95rem;
            cursor: pointer; transition: 0.2s; line-height: 1.5; font-weight: 500; display: flex; align-items: flex-start; gap: 12px;
        }
        .option-btn:active:not(:disabled) { transform: scale(0.98); border-color: rgba(59, 130, 246, 0.5); background: rgba(59, 130, 246, 0.05); }
        .option-btn.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .option-letter { font-weight: 800; color: var(--text-muted); font-size: 1rem; flex-shrink: 0; width: 24px; background: rgba(255,255,255,0.05); text-align: center; border-radius: 6px; padding: 2px 0;}
        
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .option-btn.correct { background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: white; opacity: 1; }
        .option-btn.correct .option-letter { color: var(--success); background: transparent;}
        .option-btn.wrong { background: rgba(244, 63, 94, 0.15); border-color: var(--danger); opacity: 1; color: white; }
        .option-btn.wrong .option-letter { color: var(--danger); background: transparent;}
        
        /* Confidence Tracker */
        .confidence-panel { display: none; margin-top: 25px; animation: fadeIn 0.3s; background: var(--bg-deep); padding: 15px; border-radius: var(--radius-md); border: 1px solid var(--border);}
        .confidence-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px; text-align: center; font-weight: 600; }
        .conf-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn-conf { padding: 12px 5px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; font-size: 0.85rem;}
        .btn-conf:active { transform: scale(0.95); }
        .conf-high { background: var(--success); }
        .conf-med { background: var(--warning); }
        .conf-low { background: var(--danger); }

        .explanation-box {
            background: rgba(59, 130, 246, 0.08); border-left: 4px solid var(--primary);
            padding: 20px; margin-top: 25px; border-radius: 0 var(--radius-md) var(--radius-md) 0; display: none; 
            font-size: 0.95rem; line-height: 1.6; color: #e2e8f0; animation: fadeIn 0.4s ease;
        }
        .explanation-box strong { color: white; display: block; margin-bottom: 8px; font-size: 1.05rem;}
        .dynamic-rule { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 0.85rem; color: var(--warning); display: flex; gap: 10px; align-items: flex-start; line-height: 1.5; font-weight: 500;}

        /* Analogy Box & Rich Explanations */
        .err-detailed-exp { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-top: 12px; border-left: 4px solid var(--primary); }
        .err-detailed-exp p { margin: 0 0 12px 0; font-size: 0.95rem; color: #cbd5e1; line-height: 1.6; }
        
        .analogy-box { background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 10px; border: 1px dashed rgba(245, 158, 11, 0.3); display: flex; gap: 10px; align-items: flex-start; color: var(--text-main); font-size: 0.9rem; line-height: 1.5; margin-top: 12px; }
        .analogy-box i { margin-top: 3px; font-size: 1.1rem; color: var(--warning); }

        /* --- Modals (Full Screen Overlay) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 200; display: flex; justify-content: center; align-items: flex-end;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        @media(min-width: 600px) { .modal-overlay { align-items: center; } }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-sheet {
            background: var(--bg-card); border-top: 1px solid var(--border);
            width: 100%; max-width: 600px; padding: 25px; border-radius: 30px 30px 0 0;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding-bottom: max(25px, env(safe-area-inset-bottom));
            max-height: 90vh; overflow-y: auto;
        }
        @media(min-width: 600px) { .modal-sheet { border-radius: 24px; } }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        /* Document/Lesson Specific Modal Styles */
        .doc-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .doc-icon { width: 50px; height: 50px; border-radius: 12px; background: rgba(59, 130, 246, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .doc-title { font-size: 1.3rem; font-weight: 800; color: white; line-height: 1.3; }
        
        .doc-content { font-size: 0.95rem; color: #cbd5e1; line-height: 1.7; }
        .doc-content h4 { color: white; font-size: 1.1rem; margin: 25px 0 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .doc-content ul { padding-left: 20px; margin-bottom: 20px; }
        .doc-content li { margin-bottom: 12px; }
        .doc-content strong { color: var(--secondary); font-weight: 700; }
        .doc-content p { margin-bottom: 15px; }
        
        .isaca-trap {
            background: rgba(244, 63, 94, 0.1); border: 1px solid rgba(244, 63, 94, 0.4);
            padding: 15px; border-radius: 12px; margin: 25px 0; color: var(--text-main);
            border-left: 4px solid var(--danger);
        }
        .isaca-trap strong { display: flex; align-items: center; gap: 8px; color: #fca5a5; margin-bottom: 8px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;}

        /* --- Review Tab Rules Scroll --- */
        .rules-scroller {
            display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
        }
        .rules-scroller::-webkit-scrollbar { display: none; }
        .rule-card { 
            background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); 
            padding: 15px; border-radius: var(--radius-md); min-width: 260px; scroll-snap-align: start; flex-shrink: 0;
        }
        .rule-card h3 { color: var(--warning); margin-bottom: 8px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;}
        .rule-card p { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

        /* --- Error Log / Lost Questions --- */
        .error-card { background: var(--bg-card-elevated); border: 1px solid rgba(244, 63, 94, 0.4); padding: 18px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .error-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.8rem; }
        .err-q { font-size: 1rem; margin-bottom: 12px; font-weight: 600; line-height: 1.5; color: white;}
        .err-ans { font-size: 0.9rem; color: var(--text-main); background: rgba(244, 63, 94, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--danger);}
        .err-cor { font-size: 0.9rem; color: var(--text-main); background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border-left: 3px solid var(--success);}

        /* --- Navigation (Bottom Tab Bar) --- */
        .nav-bar {
            background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around;
            padding: 12px 10px calc(12px + env(safe-area-inset-bottom)); 
            flex-shrink: 0; z-index: 100; position: relative;
        }
        .nav-btn {
            background: transparent; border: none; color: #64748b; font-size: 0.7rem; font-weight: 700;
            display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; flex: 1; transition: 0.2s;
        }
        .nav-btn i { font-size: 1.3rem; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-4px) scale(1.15); text-shadow: 0 4px 15px var(--primary-glow); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: white; color: var(--bg-deep); padding: 12px 24px; border-radius: 50px; font-weight: 800; font-size: 0.9rem; z-index: 1000; opacity: 0; transition: 0.3s; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;}
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Confetti */
        .confetti {
            position: fixed; width: 10px; height: 10px; top: -10px; z-index: 9999;
            pointer-events: none; animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>

    <svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
      <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#3b82f6" />
        <stop offset="100%" stop-color="#6366f1" />
      </linearGradient>
    </svg>

    <!-- Fixed Header -->
    <header>
        <div class="logo">
            <div class="icon-box"><i class="fa-solid fa-shield-halved"></i></div>
            <div class="logo-text">
                <span>CISA Exam Weapon</span>
                Domain 1: Auditing Process
            </div>
        </div>
        <div class="header-actions">
            <div class="streak-badge"><i class="fa-solid fa-fire"></i> <span id="streak-count">0</span></div>
        </div>
    </header>

    <!-- Scrollable Content -->
    <div class="main-content" id="main-scroll">
        
        <!-- ================= DASHBOARD (JOURNEY) VIEW ================= -->
        <div id="view-dash" class="view active">
            
            <!-- Journey Tracker -->
            <div class="card" style="padding-bottom: 30px;">
                <div class="mastery-header">
                    <h3 id="dash-pct">0%</h3>
                    <p>Total Mastery</p>
                </div>

                <div class="journey-grid">
                    <div class="j-box j-mastered">
                        <h4 id="stat-mastered">0</h4>
                        <span>Mastered</span>
                    </div>
                    <div class="j-box j-lost">
                        <h4 id="stat-lost">0</h4>
                        <span>Lost</span>
                    </div>
                    <div class="j-box j-untouched">
                        <h4 id="stat-untouched">100</h4>
                        <span>Untouched</span>
                    </div>
                </div>

                <div class="progress-track">
                    <div class="track-mastered" id="bar-mastered" style="width: 0%;"></div>
                    <div class="track-lost" id="bar-lost" style="width: 0%;"></div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 15px; line-height: 1.5;">
                    Goal: Turn all 100 Domain 1 questions green. When you get a 'Lost' question correct on a retry, it upgrades to 'Mastered'.
                </p>
            </div>

            <!-- Deep Lessons (ISACA Masterclass) -->
            <h2 class="section-title"><i class="fa-solid fa-graduation-cap"></i> Deep Lessons (D1)</h2>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">Aligned exactly with ISACA CRM 28th Edition. Tap to read.</p>
            
            <div class="lessons-scroller">
                
                <div class="lesson-card" onclick="openLessonModal('charter')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-file-contract watermark"></i>
                    <h4>1. Audit Standards & Ethics</h4>
                    <ul>
                        <li>ITAF & Standards vs Guidelines.</li>
                        <li>Approved by <strong>Board of Directors</strong>.</li>
                        <li>Code of Professional Ethics.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('risk')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-chart-line watermark"></i>
                    <h4>2. Risk-Based Planning</h4>
                    <ul>
                        <li><strong>Inherent Risk:</strong> Raw risk.</li>
                        <li><strong>Detection Risk:</strong> Auditor misses error.</li>
                        <li>FIRST step: Understand <strong>business</strong>.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('controls')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-shield-halved watermark"></i>
                    <h4>3. Internal Controls & CSA</h4>
                    <ul>
                        <li><strong>Preventive:</strong> Stops error (SoD).</li>
                        <li><strong>Detective:</strong> Finds error (Logs).</li>
                        <li><strong>CSA:</strong> Management owns risk.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('evidence')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-magnifying-glass watermark"></i>
                    <h4>4. Audit Execution & Evidence</h4>
                    <ul>
                        <li>Sufficient (Qty) & <strong>Appropriate</strong> (Qly).</li>
                        <li>Best: <strong>Auditor observation</strong>.</li>
                        <li>Worst: Oral statements.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('sampling')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-percent watermark"></i>
                    <h4>5. Sampling Methodologies</h4>
                    <ul>
                        <li><strong>Attribute:</strong> Compliance (Yes/No).</li>
                        <li><strong>Variable:</strong> Substantive (Value/$).</li>
                        <li><strong>Discovery:</strong> Fraud hunting.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('caats')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-laptop-code watermark"></i>
                    <h4>6. Data Analytics & CAATs</h4>
                    <ul>
                        <li><strong>GAS:</strong> Independent querying.</li>
                        <li><strong>ITF:</strong> Dummy entities in live DB.</li>
                        <li>Continuous Auditing vs Monitoring.</li>
                    </ul>
                </div>

                <div class="lesson-card" onclick="openLessonModal('reporting')">
                    <div class="tap-to-read">Tap to read</div>
                    <i class="fa-solid fa-bullhorn watermark"></i>
                    <h4>7. Reporting & Follow-Up</h4>
                    <ul>
                        <li><strong>Exit Interview:</strong> Confirm facts.</li>
                        <li><strong>Reporting:</strong> Executive summary first.</li>
                        <li><strong>Follow-Up:</strong> Verify remediation.</li>
                    </ul>
                </div>

            </div>

            <!-- Factory Reset -->
            <button onclick="hardReset()" style="width:100%; padding:15px; background:transparent; border:1px solid rgba(244, 63, 94, 0.3); color:var(--danger); border-radius:var(--radius-md); font-weight:700; cursor:pointer; margin-top:20px; margin-bottom: 20px;">
                <i class="fa-solid fa-rotate-right" style="margin-right:8px;"></i> Factory Reset Journey
            </button>
        </div>

        <!-- ================= QUICK GRIND (GRID) VIEW ================= -->
        <div id="view-quick" class="view">
            <h2 class="section-title"><i class="fa-solid fa-bolt"></i> The 100 Q Grid</h2>
            <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:20px; line-height: 1.5;">
                Tap a box to practice. <span style="color:var(--success); font-weight:700;">Green = Mastered.</span> <span style="color:var(--danger); font-weight:700;">Red = Lost.</span>
            </p>
            
            <button class="btn-spin-grid" id="quickSpinBtn" onclick="triggerQuickSpin()">
                <i class="fa-solid fa-dice"></i> Spin Random Unmastered
            </button>

            <div class="game-grid" id="quick-grid">
                <!-- Grid Items Injected via JS -->
            </div>
        </div>

        <!-- ================= PRACTICE/QUIZ VIEW ================= -->
        <div id="view-quiz" class="view">
            <div id="quiz-menu">
                <h2 class="section-title"><i class="fa-solid fa-dumbbell"></i> The Simulator</h2>
                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; line-height: 1.5;">
                    Deep work sessions. Test your endurance.
                </p>
                
                <div class="mode-btn" onclick="startQuiz('adaptive')">
                    <div class="mode-title"><i class="fa-solid fa-truck-medical"></i> Grind "Lost" Questions</div>
                    <div class="mode-desc">Automatically loads only the questions you've previously gotten wrong. Instant grading.</div>
                </div>

                <div class="mode-btn" onclick="startQuiz('practice')" style="border-color: rgba(16, 185, 129, 0.3);">
                    <div class="mode-title" style="color: var(--success);"><i class="fa-solid fa-vial"></i> D1 Full Practice (20 Qs)</div>
                    <div class="mode-desc">Randomly selects 20 questions. Untimed. Instant grading and detailed explanations.</div>
                </div>

                <div class="mode-btn" onclick="startQuiz('exam')" style="border-color: rgba(244, 63, 94, 0.4);">
                    <div class="mode-title" style="color: var(--danger);"><i class="fa-solid fa-stopwatch"></i> Hardcore Exam Mode</div>
                    <div class="mode-desc">All 100 questions. Strict 1h 30m timer. No feedback. Grades everything at the end.</div>
                </div>
            </div>

            <!-- ACTIVE QUIZ UI -->
            <div id="quiz-engine" class="quiz-container">
                <div class="card" style="margin-bottom: 0;">
                    <div class="quiz-top-bar">
                        <span class="topic-tag" id="quiz-topic">Subtopic</span>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span class="quiz-timer" id="session-timer"><i class="fa-regular fa-clock"></i> 00:00</span>
                            <span class="quiz-counter" id="quiz-counter">1/100</span>
                        </div>
                    </div>
                    
                    <div class="mindset-alert" id="mindset-alert">
                        <i class="fa-solid fa-triangle-exclamation"></i> <span>MINDSET TRAP: "<strong>WORD</strong>"</span>
                    </div>
                    
                    <div class="q-text" id="q-text">Loading question...</div>
                    
                    <!-- Options container -->
                    <div id="options-container"></div>
                    
                    <div id="explanation-container"></div> <!-- Dynamic container for exp + analogy -->
                    
                    <button class="btn-main" id="btn-next" onclick="nextQuestion()" style="display: none; margin-top: 20px;">Next Question <i class="fa-solid fa-arrow-right"></i></button>
                    <button class="btn-main success" id="btn-finish" onclick="finishQuiz()" style="display: none; margin-top: 20px;"><i class="fa-solid fa-flag-checkered"></i> Finish Session</button>
                </div>
            </div>
        </div>

        <!-- ================= REVIEW & ERROR LOG VIEW ================= -->
        <div id="view-review" class="view">
            
            <h2 class="section-title"><i class="fa-solid fa-scale-balanced"></i> ISACA Golden Rules</h2>
            <div class="rules-scroller">
                <div class="rule-card"><h3><i class="fa-solid fa-heart-pulse"></i> 1. Human Life is #1</h3><p>Evacuation and safety always supersede saving data or servers.</p></div>
                <div class="rule-card"><h3><i class="fa-solid fa-user-tie"></i> 2. Auditors Don't Fix</h3><p>Report & recommend. Mgmt fixes. Fixing breaks independence.</p></div>
                <div class="rule-card"><h3><i class="fa-solid fa-bullseye"></i> 3. FIRST Step = Business</h3><p>Identify assets/business goals before IT tech or risk assessments.</p></div>
                <div class="rule-card"><h3><i class="fa-solid fa-shield-halved"></i> 4. Preventive > Detective</h3><p>Stopping an error (SoD, Access Controls) > Logging an error.</p></div>
                <div class="rule-card"><h3><i class="fa-solid fa-gavel"></i> 5. Board Approves Charter</h3><p>The Audit Charter is static and approved by highest level (Board/Audit Comm).</p></div>
            </div>

            <h2 class="section-title" style="margin-top: 30px;"><i class="fa-solid fa-book-skull"></i> Mistake Journal</h2>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:20px;">These are the questions you got wrong. Study the explanations and the analogies to permanently fix your blind spots.</p>
            
            <div id="error-list">
                <!-- Injected via JS -->
            </div>
        </div>

    </div> <!-- End Main Content -->

    <!-- ================= QUICK PLAY MODAL ================= -->
    <div class="modal-overlay" id="quickModalOverlay" onclick="closeQuickModal(event)">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="topic-tag" id="qm-topic" style="margin:0;">Topic</span>
                <span style="font-size:0.85rem; color:var(--text-muted); font-weight:700; background:rgba(255,255,255,0.05); padding:4px 10px; border-radius:8px;" id="qm-num">Q #1</span>
            </div>
            
            <div class="q-text" id="qm-text" style="font-size:1.1rem; margin-bottom:25px;">Question text</div>
            
            <!-- User MUST select an option to see the answer -->
            <div id="qm-options-container" style="margin-bottom: 25px;"></div>
            
            <div class="explanation-box" id="qm-exp" style="display:none; border-radius: var(--radius-md); border-left: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: white; margin-top: 0; margin-bottom: 20px;"></div>
            
            <button class="btn-main" id="qm-done-btn" onclick="closeQuickModal()" style="margin-top: 15px; background: var(--success); display: none;">
                <i class="fa-solid fa-arrow-right"></i> Continue
            </button>
        </div>
    </div>

    <!-- ================= LESSON MODAL (DETAILED DOCUMENTS) ================= -->
    <div class="modal-overlay" id="lessonModalOverlay" onclick="closeLessonModal(event)">
        <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height: 95vh;">
            
            <div class="doc-header">
                <div class="doc-icon" id="lm-icon"><i class="fa-solid fa-file"></i></div>
                <div class="doc-title" id="lm-title">Lesson Title</div>
            </div>

            <div class="doc-content" id="lm-content">
                <!-- Content injected via JS -->
            </div>

            <button class="btn-main" onclick="closeLessonModal()" style="margin-top: 30px;">
                <i class="fa-solid fa-check"></i> I Understand
            </button>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <!-- Navigation Tab Bar -->
    <nav class="nav-bar">
        <button class="nav-btn active" onclick="switchView('dash')" id="nav-dash">
            <i class="fa-solid fa-route"></i>
            <span>Journey</span>
        </button>
        <button class="nav-btn" onclick="switchView('quick')" id="nav-quick">
            <i class="fa-solid fa-bolt"></i>
            <span>Grid</span>
        </button>
        <button class="nav-btn" onclick="switchView('quiz')" id="nav-quiz">
            <i class="fa-solid fa-laptop-code"></i>
            <span>Simulate</span>
        </button>
        <button class="nav-btn" onclick="switchView('review')" id="nav-review">
            <i class="fa-solid fa-clipboard-list"></i>
            <span>Review</span>
        </button>
    </nav>

    <script>
        // ================= AUDIO ENGINE =================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;

                if (type === 'tick') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                } else if (type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
            } catch (e) {
                console.error("Audio playback prevented by browser policy", e);
            }
        }

        // ================= CONFETTI / BALLOONS ENGINE =================
        function triggerConfetti() {
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#f8fafc'];
            for(let i=0; i<40; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.animationDuration = (Math.random() * 2 + 1) + 's';
                if (Math.random() > 0.5) c.style.borderRadius = '50%';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        // ================= LESSONS DATA (BASED ON ISACA CRM 28th EDITION) =================
        const lessonsDB = {
            'charter': {
                title: "1. Audit Standards & Ethics",
                icon: '<i class="fa-solid fa-file-contract"></i>',
                content: `
                    <p>The IS audit function must be governed by rigorous standards to ensure quality, independence, and objectiveness as defined in the ISACA IT Assurance Framework (ITAF).</p>
                    
                    <h4>ITAF (IT Assurance Framework)</h4>
                    <ul>
                        <li><strong>Standards:</strong> These are <em>mandatory</em> requirements. Auditors must comply with them.</li>
                        <li><strong>Guidelines:</strong> These provide guidance on how to apply the standards. They are <em>recommended</em> but not mandatory.</li>
                        <li><strong>Tools and Techniques:</strong> These provide examples of processes and tools to assist the auditor.</li>
                    </ul>

                    <h4>The IS Audit Charter</h4>
                    <p>The Audit Charter is the overarching document that establishes the role, authority, and accountability of the IS audit function.</p>
                    <ul>
                        <li><strong>Approval:</strong> It MUST be approved by the highest level of governance (<strong>Board of Directors</strong> or Audit Committee).</li>
                        <li><strong>Authority:</strong> It grants the auditor explicit rights of access to systems, data, and personnel.</li>
                        <li><strong>Static Nature:</strong> It is a <em>static</em> document. It does not change yearly.</li>
                    </ul>

                    <div class="isaca-trap">
                        <strong><i class="fa-solid fa-triangle-exclamation"></i> ISACA TRAP: "The Schedule"</strong>
                        The charter does <b>NOT</b> contain the annual audit schedule, budget, project plans, or specific audit methodologies. That belongs in the <em>Annual Audit Plan</em>.
                    </div>

                    <h4>Code of Professional Ethics</h4>
                    <p>Auditors must be independent in <em>fact</em> (mindset) and <em>appearance</em> (how others view them). They must also engage in <strong>Continuing Professional Education (CPE)</strong> to maintain competency.</p>
                `
            },
            'risk': {
                title: "2. Risk-Based Planning",
                icon: '<i class="fa-solid fa-chart-line"></i>',
                content: `
                    <p>Auditors cannot test everything. A risk-based audit approach is used to allocate audit resources to the areas of highest risk.</p>

                    <h4>The Golden Rule of Planning</h4>
                    <p>The very <strong>FIRST</strong> step in any audit planning or risk assessment is to <strong>understand the business mission and objectives</strong>. IT only exists to support the business.</p>

                    <h4>The Risk Model</h4>
                    <ul>
                        <li><strong>Inherent Risk:</strong> The raw risk level of a process assuming NO internal controls exist.</li>
                        <li><strong>Control Risk:</strong> The risk that a material error exists and the organization's internal controls <em>fail</em> to prevent or detect it.</li>
                        <li><strong>Detection Risk:</strong> The risk that the <em>IS auditor's testing</em> fails to find a material error. This is the ONLY risk the auditor can directly control (by increasing sample sizes).</li>
                        <li><strong>Audit Risk:</strong> The risk of reaching an incorrect conclusion. (Audit Risk = Inherent × Control × Detection).</li>
                    </ul>

                    <h4>Risk Responses</h4>
                    <ul>
                        <li><strong>Mitigate:</strong> Implementing controls to reduce risk.</li>
                        <li><strong>Transfer:</strong> Buying insurance or outsourcing (shifts financial burden).</li>
                        <li><strong>Avoid:</strong> Stopping the risky activity entirely.</li>
                        <li><strong>Accept:</strong> Doing nothing, usually because control costs exceed asset value.</li>
                    </ul>

                    <div class="isaca-trap">
                        <strong><i class="fa-solid fa-triangle-exclamation"></i> ISACA TRAP: "Accepting Risk"</strong>
                        Auditors do NOT accept risk. Only <strong>Management</strong> can accept risk. The auditor identifies and reports the risk.
                    </div>
                `
            },
            'controls': {
                title: "3. Internal Controls & CSA",
                icon: '<i class="fa-solid fa-shield-halved"></i>',
                content: `
                    <p>Internal controls mitigate risk, promote accountability, and prevent fraud.</p>

                    <h4>Control Classifications</h4>
                    <ul>
                        <li><strong>Preventive:</strong> Stops the error or fraud <em>before</em> it occurs. (e.g., Segregation of Duties, Firewalls, Mantraps). <em>ISACA considers these the strongest type of control.</em></li>
                        <li><strong>Detective:</strong> Identifies the error <em>after</em> it has occurred. (e.g., Log reviews, Intrusion Detection Systems (IDS), Audits, CCTV).</li>
                        <li><strong>Corrective:</strong> Fixes the damage after the error is detected. (e.g., Backups, Disaster Recovery Plans, Patching).</li>
                        <li><strong>Compensating:</strong> An alternative control used when a primary control is unfeasible or too expensive to implement.</li>
                        <li><strong>Directive:</strong> Administrative controls (e.g., Policies, Guidelines) that direct behavior.</li>
                    </ul>

                    <div class="isaca-trap">
                        <strong><i class="fa-solid fa-triangle-exclamation"></i> ISACA TRAP: "Preventive > Detective"</strong>
                        If a question asks for the "BEST" way to secure a system, look for a <strong>Preventive</strong> control. It is always better to lock the door than to review the security tape after the robbery.
                    </div>

                    <h4>Control Self-Assessment (CSA)</h4>
                    <p>A methodology where management and staff evaluate the effectiveness of their own internal controls. It shifts ownership and awareness of risk to the line managers.</p>
                    <p>The auditor's role in a CSA is strictly as a <strong>facilitator</strong>. Management owns the risk and the assessment.</p>
                `
            },
            'evidence': {
                title: "4. Audit Execution & Evidence",
                icon: '<i class="fa-solid fa-magnifying-glass"></i>',
                content: `
                    <p>Audit evidence is the information used by the auditor to arrive at the conclusions on which the audit opinion is based.</p>

                    <h4>Characteristics of Evidence</h4>
                    <ul>
                        <li><strong>Sufficient:</strong> Refers to the <em>quantity</em> of evidence (Did you test enough samples?).</li>
                        <li><strong>Appropriate:</strong> Refers to the <em>quality</em> and <em>reliability</em> of the evidence (Is it relevant and objective?).</li>
                    </ul>

                    <h4>Hierarchy of Evidence Reliability (Best to Worst)</h4>
                    <ol>
                        <li><strong>Auditor's direct observation:</strong> The auditor physically verifies it themselves.</li>
                        <li><strong>Independent Third-Party Confirmation:</strong> Evidence received directly from an external source (e.g., Bank confirmation).</li>
                        <li><strong>Internal system-generated reports:</strong> Reliable if IT General Controls (ITGCs) are strong.</li>
                        <li><strong>Internal manual documents:</strong> Invoices, signed papers (susceptible to forgery).</li>
                        <li><strong>Oral statements / Interviews:</strong> The absolute weakest form of evidence.</li>
                    </ol>

                    <div class="isaca-trap">
                        <strong><i class="fa-solid fa-triangle-exclamation"></i> ISACA TRAP: "Trust, but Verify"</strong>
                        If an IT Manager promises that a system is patched or a policy is enforced, the auditor must <strong>independently verify</strong> the claim using technical tests or observation. Interviews are never enough.
                    </div>
                `
            },
            'sampling': {
                title: "5. Sampling Methodologies",
                icon: '<i class="fa-solid fa-percent"></i>',
                content: `
                    <p>Auditors use statistical sampling to draw mathematically sound conclusions about an entire population.</p>

                    <h4>Types of Sampling</h4>
                    <ul>
                        <li><strong>Attribute Sampling:</strong> Used for <em>Compliance Testing</em>. Deals with binary, Yes/No questions. (e.g., Is the manager's signature present? Yes or No).</li>
                        <li><strong>Variable Sampling:</strong> Used for <em>Substantive Testing</em>. Deals with numeric values, weights, or money. (e.g., Estimating the total dollar amount of payroll errors).</li>
                        <li><strong>Discovery Sampling:</strong> Used when the expected error rate is 0%. If even <em>one</em> error is found, testing stops. Primarily used to hunt for <strong>Fraud</strong>.</li>
                        <li><strong>Stop-and-Go Sampling:</strong> Used to minimize sample size when very few errors are expected. Tests a small batch, and stops early if no errors are found.</li>
                    </ul>

                    <h4>Sampling Risks & Metrics</h4>
                    <ul>
                        <li><strong>Sampling Risk:</strong> The risk that the sample does not accurately represent the population. (A 95% Confidence Level means a 5% Sampling Risk).</li>
                        <li><strong>Tolerable Error Rate:</strong> The maximum error rate in the population that the auditor is willing to accept before determining the control is completely ineffective.</li>
                    </ul>
                    <p><em>To decrease sampling risk (and increase confidence), the auditor must <strong>increase the sample size</strong>.</em></p>
                `
            },
            'caats': {
                title: "6. Data Analytics & CAATs",
                icon: '<i class="fa-solid fa-laptop-code"></i>',
                content: `
                    <p>Computer-Assisted Audit Techniques (CAATs) enable auditors to gather evidence independently and test massive amounts of data.</p>

                    <h4>Key CAATs Tools</h4>
                    <ul>
                        <li><strong>Generalized Audit Software (GAS):</strong> Allows auditors to write scripts to query databases independently, analyzing 100% of the data rather than a small sample. It preserves <strong>auditor independence</strong> because they don't rely on IT staff to pull reports.</li>
                        <li><strong>Integrated Test Facility (ITF):</strong> Creating a "dummy" entity in the live production system to run test transactions alongside real data. <em>Crucial rule: Dummy test data must be removed to avoid corrupting the real financials!</em></li>
                        <li><strong>Parallel Simulation:</strong> The auditor takes the client's live data and processes it through the <em>auditor's own software</em> to see if the output matches the client's system output.</li>
                    </ul>

                    <h4>Continuous Auditing vs. Monitoring</h4>
                    <ul>
                        <li><strong>Continuous Monitoring:</strong> Performed by <em>Management</em> to ensure processes are working efficiently on a daily basis.</li>
                        <li><strong>Continuous Auditing:</strong> Performed by <em>IS Auditors</em> using automated tools to gather evidence and detect anomalies in real-time.</li>
                    </ul>
                `
            },
            'reporting': {
                title: "7. Reporting & Follow-Up",
                icon: '<i class="fa-solid fa-bullhorn"></i>',
                content: `
                    <p>The final phase of the audit process involves communicating results to management and ensuring remediation occurs.</p>

                    <h4>The Exit Interview</h4>
                    <p>Before the final report is published, the auditor conducts an exit interview with management. The primary purpose is to <strong>ensure the factual accuracy</strong> of the findings and guarantee there are no surprises in the final report.</p>

                    <div class="isaca-trap">
                        <strong><i class="fa-solid fa-triangle-exclamation"></i> ISACA TRAP: "Management Disagreements"</strong>
                        If management disagrees with a valid finding, the auditor does NOT remove it. The finding stays, and management's disagreement is formally noted in their response section.
                    </div>

                    <h4>Audit Reporting</h4>
                    <p>Audit reports should be structured for <strong>Senior Management</strong>. The Executive Summary is the most important part, highlighting material business impacts rather than deep technical jargon.</p>

                    <h4>Follow-up Procedures</h4>
                    <p>An audit is not truly complete until a follow-up is conducted. The auditor's primary responsibility during follow-up is to verify that management has <strong>implemented the agreed-upon corrective actions</strong> based on the timelines provided in their management response.</p>
                `
            }
        };

        function openLessonModal(lessonKey) {
            haptic();
            const data = lessonsDB[lessonKey];
            if(!data) return;

            const iconEl = document.getElementById('lm-icon');
            if (iconEl) iconEl.innerHTML = data.icon;
            
            const titleEl = document.getElementById('lm-title');
            if (titleEl) titleEl.textContent = data.title;
            
            const contentEl = document.getElementById('lm-content');
            if (contentEl) contentEl.innerHTML = data.content;

            const modalOverlay = document.getElementById('lessonModalOverlay');
            if (modalOverlay) modalOverlay.classList.add('active');
        }

        function closeLessonModal(e) {
            const modalOverlay = document.getElementById('lessonModalOverlay');
            if (!modalOverlay) return;
            if (!e || e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        }

        // ================= CISA 100 QUESTIONS DATA =================
        const isacaKeywords = /\b(FIRST|BEST|MOST|PRIMARY|GREATEST|ULTIMATELY|LEAST|MAIN)\b/g;

        const d1Topics = [
            "Audit Charter & Mgmt", 
            "Risk Assessment", 
            "Audit Evidence & Sampling", 
            "Internal Controls & CSA", 
            "Reporting & Follow-up"
        ];

        // 100 Master Questions strictly focused on Domain 1 (28th Edition)
        const quizDB = [
            // PART 1: Audit Charter & Ethics (ITAF)
            { id: 1, topic: "Audit Charter & Mgmt", q: "A long-term IT employee with a strong technical background has applied for a position in the IS audit department. Hiring should be primarily based on the individual’s experience and:", options: ["Length of service.", "Age and capacity to learn.", "IT knowledge for credibility.", "Ability to be independent of existing IT relationships."], a: 3, exp: "Independence is fundamental. An auditor cannot effectively audit a department they were recently part of without a conflict of interest.", rule: "Independence must be maintained in fact and appearance.", analogy: "Imagine a referee officiating a game for a team they used to play for. Even if they are fair, the appearance of bias ruins the game." },
            { id: 2, topic: "Audit Charter & Mgmt", q: "What is the PRIMARY purpose of an audit charter?", options: ["State the objectives and scope of a specific audit.", "Outline the technical audit methodology.", "Document the IS audit function's authority, scope, and responsibility.", "Define the timeline and budget for the audit department."], a: 2, exp: "An audit charter is the foundational document that grants the auditor the authority and independence to operate.", rule: "Charter = Authority, Scope, Responsibility. Approved by the Board.", analogy: "The charter is a police officer's badge. It proves they have the authority to ask questions and inspect the premises." },
            { id: 3, topic: "Audit Charter & Mgmt", q: "Who should officially approve the IS Audit Charter?", options: ["The Chief Information Officer (CIO)", "The Chief Information Security Officer (CISO)", "The Audit Committee or Board of Directors", "The Lead IS Auditor"], a: 2, exp: "To guarantee independence, the charter must be approved by the highest level of governance (Audit Committee/Board).", rule: "Audit Charter must be approved by the Board/Audit Committee.", analogy: "A constitution must be approved by the supreme rulers of the land, not a middle-manager." },
            { id: 4, topic: "Audit Charter & Mgmt", q: "When using the work of an external expert (Subject Matter Expert), the IS auditor is ULTIMATELY responsible for:", options: ["The accuracy of the expert's technical tools.", "Paying the expert's invoice.", "Evaluating the expert's work and the final audit conclusions.", "Training the expert on audit methodology."], a: 2, exp: "You can outsource the testing, but you cannot outsource the responsibility. The lead auditor owns the final report.", rule: "Auditor retains ultimate responsibility for the report.", analogy: "The lead architect hires a plumber. If the pipes burst, the client blames the architect, not the plumber." },
            { id: 5, topic: "Audit Charter & Mgmt", q: "An IS auditor discovers they are related to the IT Director of the department they are auditing. What is the BEST course of action?", options: ["Proceed but exercise extreme objectivity.", "Disclose the relationship in the final audit report.", "Inform audit management so they can be reassigned.", "Only audit areas not directly managed by the IT Director."], a: 2, exp: "This is a clear impairment of independence. The auditor must step down from this specific assignment.", rule: "Impairment of independence requires immediate disclosure and reassignment.", analogy: "A judge cannot preside over a murder trial if the defendant is their brother." },
            { id: 6, topic: "Audit Charter & Mgmt", q: "Which of the following is NOT typically found in an IS Audit Charter?", options: ["The authority of the audit function.", "The independence of the audit function.", "The detailed annual audit schedule.", "The scope of the audit function's responsibilities."], a: 2, exp: "The annual schedule changes every year. The Charter is a static, overarching governance document.", rule: "Charter = High-level authority. Does NOT include specific schedules/budgets.", analogy: "The US Constitution doesn't list what the President is eating for lunch tomorrow." },
            { id: 7, topic: "Audit Charter & Mgmt", q: "Which of the following is the MOST important factor for ensuring the IS audit function is effective?", options: ["Advanced audit software tools.", "A highly technical audit staff.", "Independence of the IS audit function.", "Frequent audits of all departments."], a: 2, exp: "Without independence, the auditor cannot objectively report findings, rendering the entire function useless.", rule: "Independence is the bedrock of the audit function.", analogy: "A judge can be the smartest person in the room (technical staff), but if they are bribed (no independence), the justice system fails." },
            { id: 8, topic: "Audit Charter & Mgmt", q: "If the IS audit department reports directly to the Chief Financial Officer (CFO), which fundamental principle might be compromised?", options: ["Competence", "Independence", "Confidentiality", "Integrity"], a: 1, exp: "If the auditor reports to the CFO, they cannot independently audit the finance department without fear of retaliation.", rule: "Reporting line dictates Independence.", analogy: "It's like the Internal Affairs police department answering directly to the corrupt police captain they are investigating." },
            { id: 9, topic: "Audit Charter & Mgmt", q: "An IS auditor is asked to design the new security architecture for the company, and then audit it next year. This is a violation of:", options: ["Professional Competence", "Segregation of Duties", "Independence", "Due Professional Care"], a: 2, exp: "An auditor cannot objectively audit a system they built. This is a massive impairment of independence.", rule: "You cannot audit your own work.", analogy: "A student writing their own final exam questions." },
            { id: 10, topic: "Audit Charter & Mgmt", q: "Which of the following is the MOST important element to include in an IS Audit Charter?", options: ["The specific audit tools to be used.", "The annual training budget for auditors.", "The auditor's right of access to systems, data, and personnel.", "The step-by-step procedures for conducting an audit."], a: 2, exp: "Without explicit, board-approved access to data and personnel, the auditor cannot do their job.", rule: "Charter must explicitly grant access rights.", analogy: "A VIP All-Access backstage pass. Without it, the security guards won't let you in." },
            { id: 11, topic: "Audit Charter & Mgmt", q: "An IS auditor is planning to use the work of a third-party security expert. The auditor must FIRST:", options: ["Pay the expert's invoice.", "Assess the expert's competence, objectivity, and independence.", "Incorporate the expert's findings directly into the report without review.", "Ask management to approve the expert's methodology."], a: 1, exp: "Before relying on someone else's work, the auditor must verify they are qualified and unbiased.", rule: "Verify SME competence and independence FIRST.", analogy: "Before you let a stranger babysit your kids, you check their references and background first." },
            { id: 12, topic: "Audit Charter & Mgmt", q: "Which standard dictates that IS auditors must maintain their knowledge and skills through continuing professional education (CPE)?", options: ["Code of Professional Ethics", "The Audit Charter", "ISACA Privacy Policy", "The Control Framework"], a: 0, exp: "The ISACA Code of Professional Ethics explicitly requires members to maintain competency through ongoing training.", rule: "CPE is an Ethical requirement.", analogy: "A doctor must keep reading medical journals to learn about new diseases. It is unethical to treat patients using 20-year-old knowledge." },
            { id: 13, topic: "Audit Charter & Mgmt", q: "The IS audit function should be functionally independent of:", options: ["The Audit Committee", "The Board of Directors", "The business operations and IT management being audited.", "External regulators"], a: 2, exp: "Auditors must be independent from the people they are auditing (Management/Operations) to remain objective.", rule: "Auditors must be independent of Operations.", analogy: "Internal Affairs investigates the police. They cannot be regular beat cops, or they would cover for their friends." },
            { id: 14, topic: "Audit Charter & Mgmt", q: "When ISACA refers to 'Due Professional Care', it means the auditor should:", options: ["Find every single error in the system.", "Guarantee that fraud will not occur.", "Perform the audit with the competence and skill expected of a professional.", "Rely completely on management's assertions."], a: 2, exp: "Due professional care means doing the job to the best of your professional ability, but it does NOT guarantee absolute assurance that all errors will be found.", rule: "Due care means professional diligence, not absolute perfection.", analogy: "A surgeon provides due care by performing the surgery correctly. They cannot guarantee the patient will live forever." },
            { id: 15, topic: "Audit Charter & Mgmt", q: "An IS auditor is asked to participate in an IT steering committee. To maintain independence, the auditor should ONLY:", options: ["Vote on the approval of new IT projects.", "Serve in an advisory capacity without making management decisions.", "Take minutes for the committee meetings.", "Refuse to attend the meetings entirely."], a: 1, exp: "Auditors can advise management, but they cannot make or vote on management decisions without impairing their independence.", rule: "Auditors advise, they do not decide.", analogy: "A financial advisor can suggest stocks, but you are the one who actually presses the 'Buy' button." },

            // PART 2: Risk-Based Audit Planning
            { id: 16, topic: "Risk Assessment", q: "Which of the following is the MAIN reason to perform a risk assessment in the planning phase of an IS audit?", options: ["To ensure management’s concerns are addressed", "To provide reasonable assurance material items will be addressed", "To ensure the audit team will perform audits within budget", "To develop audit program and procedures needed to perform the audit"], a: 1, exp: "Risk assessments tell the auditor where the biggest threats are, focusing the audit on material (significant) items.", rule: "Risk-based auditing focuses limited resources on high-risk areas.", analogy: "A doctor triage's patients in an ER. You treat the heart attack (high risk) before the sprained ankle (low risk)." },
            { id: 17, topic: "Risk Assessment", q: "During a risk-based audit planning process, what should be the IS auditor's FIRST step?", options: ["Identify the control procedures currently in place.", "Determine the vulnerabilities associated with the IT infrastructure.", "Gain an understanding of the organization's business mission and objectives.", "Evaluate the results of the previous audit."], a: 2, exp: "You cannot identify what is at risk until you understand what the business is trying to achieve. Business comes first.", rule: "Business objectives ALWAYS precede IT infrastructure/controls.", analogy: "You can't buy insurance for a house until you know how much the house is actually worth." },
            { id: 18, topic: "Risk Assessment", q: "In the context of IS auditing, what does 'inherent risk' mean?", options: ["The risk that an auditor will fail to detect a material error.", "The risk that a control will fail to prevent a material error.", "The susceptibility of an asset to a material error assuming there are no related controls.", "The risk that management will ignore the audit findings."], a: 2, exp: "Inherent risk is the raw, natural level of risk associated with a process before any security controls are applied.", rule: "Inherent (Raw) -> Controls applied -> Residual (Remaining) Risk.", analogy: "Jumping out of an airplane has a massive Inherent Risk. Wearing a parachute is the Control. Landing safely with a bruised knee is the Residual risk." },
            { id: 19, topic: "Risk Assessment", q: "Management has decided to accept a known risk because the cost of the control exceeds the value of the asset. What should the IS auditor do?", options: ["Report the issue to the external regulatory body.", "Force management to implement the control.", "Document management's decision and verify it aligns with risk tolerance.", "Implement the control on behalf of management."], a: 2, exp: "Auditors do not force fixes. If management accepts a risk that aligns with policy, the auditor simply documents the decision.", rule: "Auditors advise; Management decides and accepts risk.", analogy: "The mechanic tells you the car needs a $5000 engine fix. The car is only worth $2000. You decide not to fix it. The mechanic just notes it on the receipt." },
            { id: 20, topic: "Risk Assessment", q: "Which type of risk is defined as the risk that the IS auditor's procedures will not find a material error that actually exists?", options: ["Inherent Risk", "Control Risk", "Detection Risk", "Business Risk"], a: 2, exp: "Detection risk is the risk that the auditor misses the problem. It is the only risk the auditor can directly control.", rule: "Auditor controls Detection Risk by doing more testing.", analogy: "A metal detector at the airport. The 'Detection Risk' is the chance a knife slips through without the machine beeping." },
            { id: 21, topic: "Risk Assessment", q: "What is 'materiality' in the context of IS auditing?", options: ["The physical hardware being audited.", "The importance or significance of an item in influencing decisions.", "The volume of data processed by the system.", "The amount of time spent on the audit."], a: 1, exp: "Materiality refers to how significant an issue is. If an error is 'material', it is large enough to change the decisions of management.", rule: "Materiality = Significance / Impact.", analogy: "Losing 10 cents is immaterial. Losing $10,000 is highly material. Auditors only care about material things." },
            { id: 22, topic: "Risk Assessment", q: "The PRIMARY purpose of performing a control walkthrough during the planning phase is to:", options: ["Gather substantive evidence.", "Understand the process design and confirm controls are in place.", "Identify all instances of fraud.", "Train the auditee on security best practices."], a: 1, exp: "A walkthrough involves tracing a single transaction to understand the process and verify control design before heavy testing begins.", rule: "Walkthrough = Verify Design and Understanding.", analogy: "Walking through a haunted house with the lights on before Halloween, just to see where the actors are hiding." },
            { id: 23, topic: "Risk Assessment", q: "An IS auditor finds that an organization has no formal risk assessment process. The auditor should FIRST:", options: ["Conduct a risk assessment for the organization.", "Recommend that management implement a risk assessment framework.", "Halt the audit until a risk assessment is done.", "Notify external regulators."], a: 1, exp: "The auditor identifies the gap and recommends management fixes it. The auditor does NOT do the risk assessment for them.", rule: "Auditors recommend. They do not perform operational duties.", analogy: "A personal trainer tells you to do pushups. They don't do the pushups for you." },
            { id: 24, topic: "Risk Assessment", q: "When evaluating IT risks, the IS auditor should place the GREATEST emphasis on:", options: ["Threats with the highest technical complexity.", "Vulnerabilities that have existed the longest.", "Risks that have the highest potential impact on business objectives.", "Risks identified in the previous year's audit."], a: 2, exp: "Impact on business objectives is always the highest priority in risk evaluation.", rule: "Business impact > Technical metrics.", analogy: "A tiny leak in the hull of a submarine (High Impact) is way more important than a massive crack in the captain's coffee mug." },
            { id: 25, topic: "Risk Assessment", q: "Which of the following describes 'Control Risk'?", options: ["The risk the auditor misses an error.", "The risk a material error occurs because there are no controls.", "The risk that a material error will not be prevented or detected by the internal control system.", "The risk of a business venture failing."], a: 2, exp: "Control risk is the probability that the organization's implemented controls fail to do their job.", rule: "Control Risk = The controls are broken/ineffective.", analogy: "You lock your front door. The 'Control Risk' is the chance that a thief can pick the lock anyway." },
            { id: 26, topic: "Risk Assessment", q: "An IS auditor is evaluating a newly proposed IT project. The MOST important factor for the auditor to verify is that the project:", options: ["Uses the latest agile development methodologies.", "Is aligned with the organization's strategic business goals.", "Has the lowest possible vendor cost.", "Will be completed within six months."], a: 1, exp: "IT projects only hold value if they align with and support business goals.", rule: "IT Strategy MUST align with Business Strategy.", analogy: "Buying a high-tech $10,000 espresso machine is useless if your business is a shoe store." },
            { id: 27, topic: "Risk Assessment", q: "The FIRST step in developing a risk management program is to:", options: ["Implement security controls.", "Identify the assets and their value to the business.", "Conduct a vulnerability scan.", "Calculate the Annualized Loss Expectancy (ALE)."], a: 1, exp: "You cannot protect what you don't know you have. Asset identification and valuation is always step one.", rule: "FIRST step in Risk = Asset Identification.", analogy: "You can't buy home insurance without telling the insurance company what is inside the house." },
            { id: 28, topic: "Risk Assessment", q: "During a risk-based audit, an IS auditor discovers a specific control is missing, but the business impact of a failure is negligible. The auditor should:", options: ["Report it as a critical finding immediately.", "Recommend implementing the control regardless of cost.", "Report the observation so management can formally accept the risk.", "Halt the audit until the control is added."], a: 2, exp: "If the impact is negligible, the risk may be within the acceptable risk appetite. The auditor reports it so management can formally accept it.", rule: "Risk is evaluated by Business Impact, and accepted by Management.", analogy: "You noticed your kid's piggy bank doesn't have a titanium lock. It only holds $2. You tell your spouse, and they accept the risk instead of buying a $500 lock." },
            { id: 29, topic: "Risk Assessment", q: "Which of the following BEST describes a vulnerability?", options: ["A hacker attempting to breach the network.", "A natural disaster like a flood.", "A weakness in the system design or implementation.", "The financial loss resulting from a breach."], a: 2, exp: "A vulnerability is a weakness. A threat (hacker/flood) exploits a vulnerability to cause an impact.", rule: "Risk = Threat x Vulnerability x Impact.", analogy: "Leaving your car window rolled down is a Vulnerability. The car thief is the Threat." },
            { id: 30, topic: "Risk Assessment", q: "In a risk assessment, the value of an information asset should be determined PRIMARILY by:", options: ["The original cost to purchase the hardware and software.", "The IT department's estimate of its technical importance.", "The impact its loss would have on the business operations.", "The cost to replace the asset with a newer version."], a: 2, exp: "An old $50 server might hold $5 million worth of customer data. The business impact determines the true value.", rule: "Asset value = Business Impact.", analogy: "A thumb drive costs $5. But if the nuclear launch codes are on it, the value is infinite." },
            { id: 31, topic: "Risk Assessment", q: "Which of the following is the BEST method for determining the frequency of IS audits?", options: ["Auditing all systems annually.", "Following the schedule of the previous year.", "Basing the frequency on a comprehensive risk assessment.", "Auditing based on the availability of audit staff."], a: 2, exp: "High-risk systems should be audited more frequently than low-risk systems. Risk dictates the schedule.", rule: "Risk Assessment drives the Audit Plan.", analogy: "You wash your hands (high risk) 10 times a day, but you only wash your car (low risk) once a month." },
            { id: 32, topic: "Risk Assessment", q: "When developing a risk-based audit plan, the IS auditor should evaluate risk based on:", options: ["Inherent risk and Control risk.", "Detection risk and Audit risk.", "Business risk and Vendor risk.", "Financial risk and Operational risk."], a: 0, exp: "The auditor evaluates Inherent Risk (raw risk) and Control Risk (controls failing) to determine how much testing they need to do.", rule: "Audit Planning relies on Inherent + Control risk.", analogy: "Before crossing the street, you look at the speed of the cars (Inherent risk) and whether the traffic light is working (Control risk)." },
            { id: 33, topic: "Risk Assessment", q: "A company implements a strict password policy and a firewall to reduce the likelihood of a breach. This is an example of risk:", options: ["Avoidance", "Acceptance", "Mitigation", "Transfer"], a: 2, exp: "Mitigation (or reduction) involves implementing controls to lessen the probability or impact of a threat.", rule: "Controls = Risk Mitigation.", analogy: "Wearing a seatbelt doesn't stop the crash (avoidance), but it mitigates the damage to your body." },
            { id: 34, topic: "Risk Assessment", q: "Which formula accurately describes the components of an IT risk?", options: ["Risk = Threat x Vulnerability x Impact", "Risk = Asset Value x Control effectiveness", "Risk = Inherent Risk x Detection Risk", "Risk = Probability + Mitigation"], a: 0, exp: "Risk requires a Threat actor exploiting a Vulnerability, resulting in a business Impact.", rule: "Risk = Threat x Vuln x Impact.", analogy: "A thief (Threat) finds an unlocked door (Vulnerability) and steals the TV (Impact)." },
            { id: 35, topic: "Risk Assessment", q: "What is the PRIMARY purpose of establishing a 'Risk Appetite'?", options: ["To eliminate all IT risks.", "To dictate the exact budget for IT security.", "To define the amount of risk management is willing to accept in pursuit of its goals.", "To guarantee compliance with all local laws."], a: 2, exp: "Risk appetite provides the threshold. If a risk is below the appetite, management accepts it. If it's above, they mitigate it.", rule: "Risk Appetite = Acceptable boundary of risk.", analogy: "Knowing exactly how spicy you like your food before you order at a Thai restaurant." },

            // PART 3: Internal Controls & CSA
            { id: 36, topic: "Internal Controls & CSA", q: "An IS auditor notes that failed login attempts to a core financial system are automatically logged and retained for a year. This logging is:", options: ["An effective preventive control.", "A valid detective control.", "Not an adequate control.", "A corrective control."], a: 1, exp: "Logging records events *after* they occur, making it a Detective control. It does not block the attempt.", rule: "Preventive blocks. Detective alerts/logs. Corrective restores.", analogy: "A security camera (Detective) films the burglar. A heavy steel door (Preventive) keeps them out." },
            { id: 37, topic: "Internal Controls & CSA", q: "A PRIMARY benefit derived for an organization employing control self-assessment (CSA) techniques is that it:", options: ["Can identify high-risk areas that might need a detailed review later.", "Allows IS auditors to independently assess risk.", "Can be used as a replacement for traditional audits.", "Allows management to relinquish responsibility for control."], a: 0, exp: "CSA shifts primary review tasks to line management, identifying high-risk areas quickly without replacing the actual audit.", rule: "In CSA, the auditor is merely a facilitator. Management owns the controls.", analogy: "It’s like asking students to grade their own practice quizzes before the teacher gives the final exam." },
            { id: 38, topic: "Internal Controls & CSA", q: "A control designed to minimize the impact of an event after it has already occurred is called a:", options: ["Preventive control", "Detective control", "Corrective control", "Directive control"], a: 2, exp: "Corrective controls act after detection to restore the system (e.g., backups, patching, DRP).", rule: "Corrective controls fix the damage.", analogy: "The car airbag (Corrective) deploys only after the crash happens to minimize your injury." },
            { id: 39, topic: "Internal Controls & CSA", q: "A primary control is deemed too expensive to implement. Management implements an alternative control that mitigates the risk to an acceptable level. This is known as a:", options: ["Directive control", "Detective control", "Compensating control", "Corrective control"], a: 2, exp: "A compensating control is used when a primary control is unfeasible, too costly, or fails.", rule: "Compensating control = The Backup Plan for a primary control.", analogy: "You can't afford a $2000 smart security system (Primary), so you buy a large guard dog instead (Compensating)." },
            { id: 40, topic: "Internal Controls & CSA", q: "Which of the following is the BEST example of a detective control?", options: ["Data validation edits", "Segregation of duties", "Review of system access logs", "Restoring from a backup tape"], a: 2, exp: "Log reviews detect unauthorized actions after they have occurred.", rule: "Logs, Alerts, and Reviews are Detective.", analogy: "Looking at your credit card statement at the end of the month to catch fraudulent charges." },
            { id: 41, topic: "Internal Controls & CSA", q: "The PRIMARY objective of Segregation of Duties (SoD) is to:", options: ["Increase operational efficiency.", "Prevent a single individual from committing and concealing fraud/errors.", "Reduce the number of IT staff needed.", "Automate manual accounting processes."], a: 1, exp: "SoD splits critical tasks so no one person has end-to-end control, reducing the risk of hidden fraud.", rule: "SoD = Fraud prevention through divided power.", analogy: "It takes two separate keys, turned by two separate soldiers at the same time, to launch a nuclear missile." },
            { id: 42, topic: "Internal Controls & CSA", q: "An access control system logically prevents unauthorized users from accessing files. This is an example of what kind of control?", options: ["Preventive", "Detective", "Corrective", "Directive"], a: 0, exp: "Access controls logically prevent unauthorized users from accessing systems or data before an incident happens.", rule: "Access controls (Logical/Physical) are Preventive.", analogy: "A bouncer checking the VIP list at the door of a club." },
            { id: 43, topic: "Internal Controls & CSA", q: "Who should be responsible for designing and implementing internal controls?", options: ["The IS Auditor", "External Regulators", "Operational Management", "The Audit Committee"], a: 2, exp: "Management owns the processes and is responsible for designing and maintaining the controls.", rule: "Management designs/owns controls. Auditors evaluate them.", analogy: "The Bank Manager builds the vault. The Auditor just checks if the vault is locked." },
            { id: 44, topic: "Internal Controls & CSA", q: "Which entity is ULTIMATELY responsible for the organization's system of internal controls?", options: ["The IS Auditor", "Executive Management / Board of Directors", "The IT Department", "External Auditors"], a: 1, exp: "Executive management and the board bear the ultimate responsibility for ensuring internal controls exist and are effective.", rule: "Management owns the controls.", analogy: "The CEO of an airline is ultimately responsible if planes crash due to bad maintenance, not the guy checking the tires." },
            { id: 45, topic: "Internal Controls & CSA", q: "An organization uses a badge swipe system to enter the server room, but employees often tailgate. What is the BEST preventive control to fix this?", options: ["Review badge logs daily.", "Install a security camera.", "Install a mantrap / deadcoded door.", "Issue a policy warning against tailgating."], a: 2, exp: "A mantrap physically prevents more than one person from entering at a time. Cameras and logs are detective.", rule: "Preventive physically stops the action.", analogy: "A turnstile at a subway station physically stops two people from walking through on one ticket." },
            { id: 46, topic: "Internal Controls & CSA", q: "Which of the following is an example of a Compensating Control?", options: ["A firewall blocking unauthorized IP addresses.", "A daily review of exception logs because duties cannot be adequately segregated.", "A policy document requiring strong passwords.", "A data backup used to restore a crashed server."], a: 1, exp: "Because Segregation of Duties (the primary control) cannot be achieved, a daily manual review (the compensating control) is added.", rule: "Compensating Control offsets a weak primary control.", analogy: "A knight doesn't have a shield (Primary), so he wears extra thick chainmail (Compensating)." },
            { id: 47, topic: "Internal Controls & CSA", q: "In a Control Self-Assessment (CSA), what is the PRIMARY role of the IS auditor?", options: ["To design the controls being assessed.", "To act as a facilitator and guide management in the assessment.", "To punish departments that fail the assessment.", "To take over the operational risk management function."], a: 1, exp: "In CSA, management does the assessing. The auditor simply provides the methodology and facilitates the workshop.", rule: "CSA Auditor = Facilitator.", analogy: "The auditor is the referee blowing the whistle, but the management team are the ones actually playing the game." },
            { id: 48, topic: "Internal Controls & CSA", q: "Which of the following controls is MOST effective in preventing a payroll clerk from modifying their own salary?", options: ["Regular review of payroll logs.", "Segregation of duties in the payroll application.", "Mandatory vacations for payroll clerks.", "Data encryption of the payroll database."], a: 1, exp: "Segregation of duties physically prevents the clerk from having the necessary access rights to authorize their own changes.", rule: "SoD is the ultimate preventive control against internal fraud.", analogy: "The bank teller takes your money, but only the vault manager has the combination to the safe." },
            { id: 49, topic: "Internal Controls & CSA", q: "What is the PRIMARY advantage of a Control Self-Assessment (CSA) program?", options: ["It replaces the need for an internal audit function.", "It shifts the responsibility of risk management entirely to the auditor.", "It increases line management's awareness and ownership of internal controls.", "It guarantees 100% compliance with external regulations."], a: 2, exp: "By forcing management to assess their own controls, they become more aware of risks and take ownership of the solutions.", rule: "CSA = Management Ownership.", analogy: "Having an employee wash their own car makes them much more careful about getting it dirty next time." },
            { id: 50, topic: "Internal Controls & CSA", q: "Which of the following is considered an administrative (directive) control?", options: ["Biometric scanner", "Intrusion Prevention System (IPS)", "Information Security Policy", "Data Backup"], a: 2, exp: "Policies, procedures, and guidelines are administrative controls that direct employee behavior.", rule: "Policies = Directive/Administrative controls.", analogy: "A 'No Smoking' sign is a directive control. It doesn't physically put out the cigarette, it relies on humans reading and obeying." },
            { id: 51, topic: "Internal Controls & CSA", q: "A bank requires a teller to enter a transaction, and a manager to approve any transaction over $5,000. This is an example of:", options: ["Compensating control", "Detective control", "Segregation of Duties", "Continuous auditing"], a: 2, exp: "Splitting the task (entry vs. approval) between two people is classic Segregation of Duties to prevent fraud.", rule: "Maker/Checker = Segregation of Duties.", analogy: "One person writes the check, another person signs it. If one goes rogue, the other stops the theft." },
            { id: 52, topic: "Internal Controls & CSA", q: "Which of the following is the BEST reason to automate internal controls?", options: ["To reduce the need for an IS auditor.", "To eliminate all inherent risks.", "To ensure controls are applied consistently without human error.", "To decrease the initial cost of system deployment."], a: 2, exp: "Automated controls do not get tired, do not forget, and cannot be socially engineered. They apply the rule 100% of the time.", rule: "Automated controls > Manual controls (Consistency).", analogy: "A human security guard might fall asleep at 3 AM. A digital keypad lock never sleeps." },
            { id: 53, topic: "Internal Controls & CSA", q: "Management has implemented a policy requiring all employees to change their passwords every 90 days. This is a:", options: ["Detective control", "Directive (Administrative) control", "Corrective control", "Physical control"], a: 1, exp: "A policy is a written rule directing behavior. (Note: The system forcing the change would be a logical preventive control).", rule: "Policies/Rules = Directive Controls.", analogy: "The Speed Limit sign on the highway is a Directive control. It tells you what to do, but doesn't physically stop your car." },
            { id: 54, topic: "Internal Controls & CSA", q: "During a compliance audit, the IS auditor finds that an IT employee has access to both the development and production environments. The auditor should FIRST:", options: ["Revoke the employee's access to production immediately.", "Report it as a high risk to the Audit Committee.", "Review the access logs to determine if unauthorized changes were made.", "Recommend implementing a mantrap at the data center."], a: 2, exp: "Before escalating or recommending fixes, the auditor must determine the impact. Reviewing logs shows if the vulnerability was exploited.", rule: "Determine impact/extent before acting.", analogy: "If you find the safe door unlocked, you first check if any money is missing before you buy a new lock." },
            { id: 55, topic: "Internal Controls & CSA", q: "Which of the following BEST represents a logical preventive control?", options: ["A smoke detector.", "A biometric fingerprint scanner on a server room door.", "A firewall blocking unauthorized ports.", "A fire suppression sprinkler system."], a: 2, exp: "A firewall is a logical (software/network) control that prevents unauthorized access. Biometrics are physical preventive.", rule: "Logical controls = Software/Networks. Physical = Tangible.", analogy: "A firewall is like a digital bouncer. A mantrap is a physical bouncer." },

            // PART 4: Audit Evidence & Sampling
            { id: 56, topic: "Audit Evidence & Sampling", q: "Which of the following forms of evidence would an IS auditor consider the MOST reliable?", options: ["An oral statement from the auditee", "The results of a test that is performed by an external IS auditor", "An internally generated computer accounting report", "A confirmation letter that is received from an outside source"], a: 1, exp: "Direct observation and tests performed independently by the auditor are the most reliable forms of evidence.", rule: "Hierarchy: Auditor Generated > External 3rd Party > Internal System > Oral.", analogy: "Seeing it rain yourself is more reliable than the weatherman telling you it's raining." },
            { id: 57, topic: "Audit Evidence & Sampling", q: "Which testing method involves an auditor checking a sample of items to verify that a specific control is operating as designed?", options: ["Substantive testing", "Compliance testing", "Analytical procedures", "Stop-and-go testing"], a: 1, exp: "Compliance testing checks if a control is present and working (Attribute). Substantive testing checks data integrity (Variable).", rule: "Compliance = Checking the Control. Substantive = Checking the Data/Math.", analogy: "Compliance is checking if the bouncer is checking IDs at the club door. Substantive is counting the cash in the register." },
            { id: 58, topic: "Audit Evidence & Sampling", q: "What is the PRIMARY benefit of implementing continuous auditing?", options: ["It eliminates the need for external auditors.", "It allows for real-time or near real-time identification of anomalies.", "It reduces the overall cost of the IT infrastructure.", "It automatically corrects errors in financial transactions."], a: 1, exp: "Continuous auditing uses automated tools to constantly monitor systems for anomalies so they can be addressed immediately.", rule: "Continuous Auditing = Real-time anomaly detection by the auditor.", analogy: "It's like a heart monitor in a hospital that beeps instantly if the heart rate drops, instead of waiting for a yearly checkup." },
            { id: 59, topic: "Audit Evidence & Sampling", q: "An IS auditor uses statistical sampling to test a population of purchase orders. If the auditor wants to decrease the margin of error, they should:", options: ["Decrease the sample size.", "Increase the sample size.", "Use non-statistical sampling instead.", "Increase the tolerable error rate."], a: 1, exp: "A larger sample size provides a more accurate mathematical representation of the population, reducing the margin of error.", rule: "Higher confidence / lower error margin requires a larger sample.", analogy: "If you want to know if soup is salty, tasting one spoonful is okay. Tasting three spoonfuls guarantees you know exactly how salty it is." },
            { id: 60, topic: "Audit Evidence & Sampling", q: "What sampling technique is BEST used when an auditor suspects fraud and wants to find at least one exception in a population?", options: ["Variable sampling", "Stop-and-go sampling", "Discovery sampling", "Stratified sampling"], a: 2, exp: "Discovery sampling is used when the expected error rate is near zero, and finding just ONE exception is critical (like fraud).", rule: "Fraud / Irregularities = Discovery Sampling.", analogy: "It's like hunting for a mouse in your house. You aren't trying to count them (Variable), you just need to find ONE to prove you have a problem." },
            { id: 61, topic: "Audit Evidence & Sampling", q: "An auditor is testing whether employees are signing the AUP. The auditor expects very few errors. Which sampling method MINIMIZES the sample size?", options: ["Discovery sampling", "Variable sampling", "Stop-and-go sampling", "Random sampling"], a: 2, exp: "Stop-and-go sampling allows the auditor to stop testing early if no errors are found in the initial small sample, minimizing audit time.", rule: "Minimize testing time = Stop-and-go sampling.", analogy: "Eating grapes. If the first 3 are sweet, you stop testing and assume the whole bunch is sweet." },
            { id: 62, topic: "Audit Evidence & Sampling", q: "When using Generalized Audit Software (GAS), what is the PRIMARY advantage for the IS auditor?", options: ["It automatically fixes errors in the database.", "It allows the auditor to independently run queries and access data.", "It eliminates the need for risk assessments.", "It replaces the need for substantive testing."], a: 1, exp: "GAS provides the auditor with independence. They don't have to ask the IT department to pull reports (which could be manipulated).", rule: "GAS/CAATs = Auditor Independence in data gathering.", analogy: "Instead of asking the chef what's in the fridge (they might lie), you use your own key (GAS) to open the fridge and look yourself." },
            { id: 63, topic: "Audit Evidence & Sampling", q: "Which testing technique allows an auditor to submit test data through the actual live production system to verify processing logic?", options: ["Parallel simulation", "Integrated Test Facility (ITF)", "Generalized Audit Software", "Snapshot technique"], a: 1, exp: "An ITF sets up a 'dummy' entity in the live production system so the auditor can run test transactions alongside real data.", rule: "ITF = Testing in Live Production with dummy entities.", analogy: "A 'Mystery Shopper' buying real items at a real store using fake corporate money to test the cashier." },
            { id: 64, topic: "Audit Evidence & Sampling", q: "Which of the following is an attribute sampling application?", options: ["Estimating the total monetary value of inventory.", "Testing the approval signatures on purchase orders.", "Calculating the average downtime of servers.", "Determining the financial impact of a breach."], a: 1, exp: "Attribute sampling deals with binary Yes/No conditions (e.g., Is the signature there or not?).", rule: "Attribute = Compliance (Yes/No). Variable = Substantive (Numbers/Money).", analogy: "Attribute: Checking if the lightbulb is ON or OFF. Variable: Measuring exactly how many watts it is pulling." },
            { id: 65, topic: "Audit Evidence & Sampling", q: "An auditor notes that a system calculation is failing. To independently verify the calculation logic, the auditor writes a script to re-process the data and compares the results. This is known as:", options: ["Integrated Test Facility (ITF)", "Parallel Simulation", "Snapshots", "Continuous Auditing"], a: 1, exp: "Parallel simulation takes live data and runs it through the auditor's own software to see if the output matches the client's output.", rule: "Parallel Simulation = Auditor Software + Live Data.", analogy: "The cashier rings up your groceries. You pull out your phone calculator and do the math at the same time to see if they match." },
            { id: 66, topic: "Audit Evidence & Sampling", q: "In audit sampling, the 'Tolerable Error Rate' represents:", options: ["The number of mistakes the auditor is allowed to make.", "The maximum error rate in the population that the auditor is willing to accept.", "The guaranteed accuracy of the sample.", "The percentage of the population that must be tested."], a: 1, exp: "Tolerable error is the threshold. If errors exceed this rate, the control is deemed ineffective.", rule: "Tolerable Error = Max acceptable failure rate.", analogy: "A pizza factory allows up to 2 burnt pizzas per 100. The 'Tolerable Error' is 2%." },
            { id: 67, topic: "Audit Evidence & Sampling", q: "When using continuous auditing, what is the PRIMARY role of the IS auditor?", options: ["To review the alerts and anomalies generated by the automated tools.", "To write the application code for the business.", "To fix the transaction errors identified by the system.", "To approve the daily financial ledgers."], a: 0, exp: "In continuous auditing, tools flag anomalies, and the auditor's job is to investigate those specific flags.", rule: "Auditor investigates anomalies; management fixes errors.", analogy: "The metal detector beeps. The auditor's job is to pat down the passenger, not to build the metal detector." },
            { id: 68, topic: "Audit Evidence & Sampling", q: "A 'Confidence Level' of 95% in statistical sampling implies:", options: ["95% of the population was tested.", "There is a 5% risk that the sample does not accurately represent the population.", "The controls are 95% effective.", "The auditor is 95% finished with the testing phase."], a: 1, exp: "A 95% confidence level means you accept a 5% sampling risk (the risk the sample is a statistical fluke).", rule: "Confidence Level + Sampling Risk = 100%.", analogy: "I am 95% sure it will rain today. Which means there is a 5% chance I am totally wrong." },
            { id: 69, topic: "Audit Evidence & Sampling", q: "An IS auditor is reviewing firewall rules. Instead of checking all 5,000 rules, the auditor uses a statistical sample. The risk that the sample does not reflect the entire rule set is called:", options: ["Inherent risk", "Control risk", "Sampling risk", "Detection risk"], a: 2, exp: "Sampling risk is the statistical probability that the sample chosen does not accurately reflect the actual population.", rule: "Sampling Risk = Fluke sample.", analogy: "You ask 3 people in Texas what their favorite sport is, and they all say Football. You assume 100% of Americans love Football. That's sampling risk." },
            { id: 70, topic: "Audit Evidence & Sampling", q: "When evaluating the reliability of audit evidence, which of the following is considered the LEAST reliable?", options: ["Evidence obtained directly by the auditor.", "Evidence provided by an independent third party.", "Evidence generated automatically by the IT system.", "Evidence provided orally by the IT manager."], a: 3, exp: "Oral evidence leaves no paper trail and is highly subjective.", rule: "Oral evidence is ALWAYS the weakest form of evidence.", analogy: "Hearsay in a court of law. 'He said he didn't do it' is the weakest defense." },
            { id: 71, topic: "Audit Evidence & Sampling", q: "An IS auditor is checking if invoices over $10,000 have the required manager signature. Which sampling method should be used?", options: ["Variable sampling", "Attribute sampling", "Stratified sampling", "Substantive sampling"], a: 1, exp: "Checking for a signature is a binary 'Yes/No' test of compliance, which requires Attribute sampling.", rule: "Attribute = Yes/No (Compliance).", analogy: "A bouncer checking IDs. He just wants to know: Are you 21? Yes or No." },
            { id: 72, topic: "Audit Evidence & Sampling", q: "When using Generalized Audit Software (GAS) to test a database, the IS auditor is performing:", options: ["Compliance testing", "Substantive testing", "Control design walkthrough", "Attribute sampling"], a: 1, exp: "Using GAS to query the actual database to look for errors, duplicates, or anomalies is testing the substance (data) itself.", rule: "GAS queries data = Substantive testing.", analogy: "Using a magnifying glass to look at the actual fingerprints on a weapon." },
            { id: 73, topic: "Audit Evidence & Sampling", q: "An auditor is using a sample to estimate the total monetary value of errors in an accounts receivable database. This is called:", options: ["Attribute sampling", "Variable sampling", "Stop-and-go sampling", "Discovery sampling"], a: 1, exp: "Variable sampling is used to estimate numerical values (like dollars, weights, or time).", rule: "Variable = Value/Numbers.", analogy: "Weighing 10 bags of flour to estimate the total weight of the truckload." },
            { id: 74, topic: "Audit Evidence & Sampling", q: "If an auditor wants to decrease the risk of drawing an incorrect conclusion from a sample (decrease sampling risk), they must:", options: ["Decrease the sample size.", "Increase the sample size.", "Change from statistical to judgmental sampling.", "Only audit the largest transactions."], a: 1, exp: "A larger sample provides more precision and reduces the risk that the sample doesn't represent the population.", rule: "Larger Sample = Less Sampling Risk = Higher Confidence.", analogy: "Flipping a coin 2 times might give you 100% heads. Flipping it 1,000 times ensures you see the true 50/50 reality." },
            { id: 75, topic: "Audit Evidence & Sampling", q: "When using the Integrated Test Facility (ITF) approach, what is the MOST critical step for the auditor?", options: ["Ensuring test data is permanently added to the production database.", "Ensuring the test transactions are removed from the system after testing.", "Running the test during peak business hours.", "Using Generalized Audit Software to create the data."], a: 1, exp: "If dummy test data is left in the live production system, it will corrupt the company's actual financial records.", rule: "ITF requires strict removal of test data.", analogy: "Using a crash test dummy in a real car. If you forget to take the dummy out before selling the car, the customer will be very confused." },
            { id: 76, topic: "Audit Evidence & Sampling", q: "When evaluating audit evidence, 'Appropriateness' refers to the evidence being:", options: ["Sufficient in quantity.", "Relevant and reliable to the audit objective.", "Approved by management.", "Generated by an automated system."], a: 1, exp: "'Sufficiency' refers to quantity. 'Appropriateness' refers to quality (relevance and reliability).", rule: "Appropriate = Quality/Relevant. Sufficient = Quantity.", analogy: "Bringing 1,000 blurry photos (Sufficient) to court doesn't help. Bringing 1 crystal-clear 4K video (Appropriate) wins the case." },
            { id: 77, topic: "Audit Evidence & Sampling", q: "The risk that the IS auditor will reach an invalid conclusion based on the test results of a sample is called:", options: ["Inherent risk", "Audit risk", "Sampling risk", "Business risk"], a: 2, exp: "Sampling risk occurs because the auditor did not test 100% of the population, leaving a chance the sample was unrepresentative.", rule: "Sampling Risk = Sample doesn't match population.", analogy: "Watching the first 5 minutes of a terrible movie and assuming the ending is bad too. You sampled it, but your conclusion might be wrong." },
            { id: 78, topic: "Audit Evidence & Sampling", q: "If an auditor is testing the effectiveness of a control over a period of time, they are performing:", options: ["Substantive testing", "Compliance testing", "A walkthrough", "Data analytics"], a: 1, exp: "Compliance testing checks if a control operated effectively and consistently over the audit period.", rule: "Control effectiveness = Compliance Testing.", analogy: "Checking the logbook every week for a year to ensure the security guard actually did his rounds." },
            { id: 79, topic: "Audit Evidence & Sampling", q: "When using CAATs to extract data for substantive testing, what is the auditor's PRIMARY concern?", options: ["Ensuring the data is encrypted during analysis.", "Ensuring the extracted data matches the original data in the live system.", "Ensuring management signs off on the script.", "Minimizing CPU usage on the production server."], a: 1, exp: "If the extracted data loses its integrity (doesn't match production), any conclusions drawn from it are completely invalid.", rule: "Evidence must be verified for accuracy and completeness before analysis.", analogy: "Before you analyze a blood sample, you must verify the label has the correct patient's name." },
            { id: 80, topic: "Audit Evidence & Sampling", q: "An auditor is reviewing an organization's network. Instead of looking at device configurations, the auditor asks the network administrator if the firewalls are configured correctly. The administrator says 'Yes'. The auditor notes this as a passing control. What rule did the auditor violate?", options: ["Sampling risk", "Trust, but Verify (Appropriate Evidence)", "Segregation of Duties", "Parallel Simulation"], a: 1, exp: "Oral evidence is the weakest form of evidence. The auditor must independently verify the configuration rather than trusting the auditee's word.", rule: "Never base a conclusion solely on oral evidence.", analogy: "A teacher asks a student if they did their homework. The student says 'yes'. The teacher gives them an A without looking at the paper." },

            // PART 5: Reporting & Follow-up
            { id: 81, topic: "Reporting & Follow-up", q: "When preparing an audit report, the IS auditor should ensure that the results are supported by:", options: ["Statements from IS management", "Work papers of other auditors", "An organizational control self-assessment", "Sufficient and appropriate audit evidence"], a: 3, exp: "Every finding in an audit report MUST be backed by sufficient and appropriate evidence gathered during fieldwork.", rule: "Opinions require concrete evidence.", analogy: "A lawyer cannot convict a criminal in court just by saying 'I think he did it'. They need the fingerprints (evidence)." },
            { id: 82, topic: "Reporting & Follow-up", q: "Which of the following is the BEST indicator of the effectiveness of an IS audit function?", options: ["The number of high-risk findings reported.", "The percentage of audit recommendations implemented by management.", "Completion of the annual audit plan within budget.", "The frequency of audit reports issued."], a: 1, exp: "Audits only add value to a business if the recommendations are actually implemented by management to fix the vulnerabilities.", rule: "Audit value is realized through management action (remediation).", analogy: "A doctor's advice is useless unless the patient actually takes the medicine." },
            { id: 83, topic: "Reporting & Follow-up", q: "During a follow-up audit, the IS auditor's PRIMARY responsibility is to:", options: ["Re-audit the entire business process.", "Verify that management has implemented the agreed-upon corrective actions.", "Report the original findings to the regulatory authorities.", "Evaluate new emerging risks in the department."], a: 1, exp: "Follow-up audits have a narrow scope: checking if management actually fixed what they promised to fix in the previous audit.", rule: "Follow-up = Verify Remediation.", analogy: "A health inspector told a restaurant to clean the floors. The follow-up visit is just to check the floors, not to inspect the whole kitchen again." },
            { id: 84, topic: "Reporting & Follow-up", q: "What is the MAIN purpose of the exit interview at the end of an audit?", options: ["To negotiate the severity of the findings.", "To ensure the facts presented in the report are accurate and agreed upon.", "To deliver the final printed audit report.", "To evaluate the performance of the audit team."], a: 1, exp: "The exit interview ensures there are no surprises and confirms factual accuracy with management before the report is finalized.", rule: "Exit Interview = Factual Accuracy & No Surprises.", analogy: "Reading the bill at a restaurant before you pay it, to make sure they didn't charge you for something you didn't order." },
            { id: 85, topic: "Reporting & Follow-up", q: "If an IS auditor uncovers a critical security vulnerability that is actively being exploited, they should:", options: ["Wait until the final report to document it.", "Fix the vulnerability themselves immediately.", "Communicate it to management immediately.", "Exclude it from the scope if it wasn't in the original plan."], a: 2, exp: "Critical, active threats must be reported to management immediately so they can stop the bleeding. Do not wait for the final report.", rule: "Imminent danger = Immediate communication.", analogy: "If a fire alarm goes off during a math test, you don't wait to finish the test before telling the principal. You yell 'FIRE!' immediately." },
            { id: 86, topic: "Reporting & Follow-up", q: "What should be included in the management response section of an IS audit report?", options: ["The auditor's opinion on management's performance.", "A detailed timeline and action plan from management to address the findings.", "A request for a larger audit budget.", "The names of employees who caused the errors."], a: 1, exp: "Management's response should acknowledge the finding and provide a concrete action plan and target date for remediation.", rule: "Management Response = Action Plan + Timeline.", analogy: "If you tell your kid their room is a mess, their response should be 'I will clean it by 5 PM', not just 'Okay'." },
            { id: 87, topic: "Reporting & Follow-up", q: "If management disagrees with an audit finding during the exit interview, the IS auditor should:", options: ["Remove the finding from the report.", "Include the finding and document management's disagreement in the report.", "Escalate immediately to external regulators.", "Modify the evidence to convince management."], a: 1, exp: "If evidence supports the finding, it stays in the report. Management's disagreement is formally noted in their response section.", rule: "Never alter factual findings based on management pressure.", analogy: "A referee calls a foul. The coach screams that it wasn't a foul. The referee keeps the penalty but notes the coach's complaint." },
            { id: 88, topic: "Reporting & Follow-up", q: "An auditor finds a minor compliance issue that does not impact security or financial reporting. The auditor should:", options: ["Ignore it to save time.", "Report it to the Board of Directors immediately.", "Include it in the report as a minor observation/recommendation.", "Demand the system be taken offline."], a: 2, exp: "All findings should be documented, but minor issues are reported as observations to local management, not escalated to the Board.", rule: "Report findings based on Materiality.", analogy: "If you notice a typo on a menu, you tell the waiter, you don't call the CEO of the restaurant chain." },
            { id: 89, topic: "Reporting & Follow-up", q: "After issuing the final audit report, the IS auditor's involvement with the auditee should:", options: ["End completely until the next annual audit.", "Continue through formal follow-up procedures to verify remediation.", "Shift to helping the auditee implement the fixes.", "Involve daily operational monitoring of the department."], a: 1, exp: "The audit lifecycle includes follow-up to ensure management actually mitigated the reported risks.", rule: "The audit is not truly complete until follow-up verifies remediation.", analogy: "A doctor gives you a prescription, but you have a follow-up appointment next week to make sure the infection actually went away." },
            { id: 90, topic: "Reporting & Follow-up", q: "An IS auditor finds a significant flaw in the financial reporting system during fieldwork. The FIRST action the auditor should take is to:", options: ["Include it in the final audit report.", "Inform the external financial auditors.", "Validate the finding and communicate it to IT management.", "Implement a temporary patch to fix the flaw."], a: 2, exp: "Before escalating to final reports, the auditor must validate the fact and inform the relevant management so they are aware.", rule: "Validate facts and communicate locally before escalating.", analogy: "If you smell smoke in a hotel room, you check the hallway (validate) and tell the front desk (local management) before calling the national news." },
            { id: 91, topic: "Reporting & Follow-up", q: "Management agreed to fix a finding by Q3. During the Q4 follow-up, the fix was not implemented. The auditor should FIRST:", options: ["Report the failure to the Board of Directors.", "Determine the reason for the delay and the current risk level.", "Revoke the IT department's operational budget.", "Close the issue and plan to review it next year."], a: 1, exp: "Before escalating, the auditor must understand WHY it wasn't fixed and what the residual risk currently is.", rule: "Investigate the root cause before escalating.", analogy: "If someone is late to a meeting, you ask them if there was traffic before you yell at them." },
            { id: 92, topic: "Reporting & Follow-up", q: "The PRIMARY objective of an audit exit interview is to:", options: ["Present the final printed report to the Board.", "Ensure the auditee agrees with the factual accuracy of the findings.", "Negotiate the severity level of the risks.", "Demand immediate remediation of all findings."], a: 1, exp: "The exit interview ensures there are no factual misunderstandings between the auditor and management before the report is finalized.", rule: "Exit Interview = Confirm Facts.", analogy: "A tailor having you try on the suit one last time before they permanently stitch the seams." },
            { id: 93, topic: "Reporting & Follow-up", q: "If management decides NOT to address a severe audit finding because of budget constraints, what is the auditor's responsibility?", options: ["Accept the risk on behalf of the company.", "Report the decision to the Board of Directors or Audit Committee.", "Force the IT department to fix it anyway.", "Remove the finding from the final report."], a: 1, exp: "Management can accept risk, but if the auditor believes the risk is too high for the business, they must escalate it to the Board.", rule: "Escalate unacceptable risk to the Board.", analogy: "If the ship captain ignores a massive hole in the hull to save money, you report it directly to the Admiral." },
            { id: 94, topic: "Reporting & Follow-up", q: "During an audit, the auditor finds that a control is operating effectively, but it is not documented in any formal procedure. The auditor should:", options: ["Ignore the issue since the control is working.", "Report a finding regarding the lack of documentation.", "Write the procedure document for the IT team.", "Fail the entire audit."], a: 1, exp: "If it's not documented, it's not repeatable, and knowledge is lost if the employee leaves. It must be reported.", rule: "Undocumented controls = Audit finding.", analogy: "A chef cooking a brilliant meal purely from memory. If he gets hit by a bus, the restaurant loses the recipe forever. It must be written down." },
            { id: 95, topic: "Reporting & Follow-up", q: "The IS auditor should structure the audit report to PRIMARILY address the needs of:", options: ["The IT operational staff.", "The external regulatory auditors.", "Senior management and the Audit Committee.", "The Chief Information Security Officer (CISO)."], a: 2, exp: "The report must be written so that senior management and the board (the ultimate decision-makers) can understand the business impact.", rule: "Write reports for Senior Management.", analogy: "A CEO doesn't want to read 40 pages of Python code. They want a 2-page summary explaining how much money they might lose." },
            { id: 96, topic: "Reporting & Follow-up", q: "During an audit, an IS auditor discovers that a previous audit finding was closed by management, but the implemented fix is completely ineffective. The auditor should:", options: ["Reopen the old finding and escalate to the Audit Committee.", "Report the ineffective fix as a new finding in the current audit.", "Ignore it, as the previous auditor signed off on it.", "Fix the issue manually to protect the company."], a: 1, exp: "It is a current control deficiency. It should be documented as a finding in the current audit report with references to the failed remediation.", rule: "Current failures are reported as current findings.", analogy: "If the plumber fixed a leak yesterday, but it's leaking again today, you write a new ticket for today's leak." },
            { id: 97, topic: "Reporting & Follow-up", q: "When an auditor writes a recommendation in the final report, it should be:", options: ["Highly technical so the IT team knows exactly which code to change.", "Focused on addressing the root cause of the finding.", "Dictating the exact vendor software management must buy.", "Vague so management has maximum flexibility."], a: 1, exp: "Recommendations should target the root cause of the vulnerability. They should NOT dictate specific technologies.", rule: "Recommendations fix the Root Cause, not the symptom.", analogy: "Telling a patient they need to eat healthier to lower blood pressure, instead of forcing them to buy a specific brand of organic broccoli." },
            { id: 98, topic: "Reporting & Follow-up", q: "What determines the scope and timeline of the auditor's follow-up activities?", options: ["The ISACA standards.", "The availability of the audit staff.", "The risk rating of the original findings and management's agreed remediation dates.", "The external auditor's schedule."], a: 2, exp: "Follow-ups are prioritized based on how severe the original risk was, and they are scheduled based on when management promised to fix it.", rule: "Follow-up schedule is driven by Risk and Target Dates.", analogy: "If a bridge is collapsing (High Risk), the city inspector follows up tomorrow. If a park bench is squeaky (Low Risk), they follow up next month." },
            { id: 99, topic: "Reporting & Follow-up", q: "Before relying on a third-party audit report (such as a SOC 2 report from a cloud provider), the IS auditor MUST FIRST:", options: ["Include the SOC 2 report in their own working papers as absolute proof of security.", "Verify the independence and qualifications of the third-party auditor.", "Request that their own IT department re-audit the cloud provider.", "Ask the cloud provider to reduce their monthly fee."], a: 1, exp: "The auditor must ensure the third-party who conducted the audit was qualified and independent before relying on their conclusions.", rule: "Verify the independence and competence of third-party reviewers.", analogy: "Before you accept a doctor's note from an employee, you verify the note came from a real, licensed hospital." },
            { id: 100, topic: "Reporting & Follow-up", q: "Which of the following documents is used to capture the auditor's testing procedures, evidence obtained, and conclusions reached during the audit?", options: ["The Audit Charter", "The Executive Summary", "Audit Working Papers", "The Management Response"], a: 2, exp: "Working papers are the auditor's official record of the work performed, the evidence gathered, and how conclusions were reached.", rule: "Working papers support the audit report.", analogy: "In math class, working papers are where you 'show your work' to prove how you got the final answer." }
        ];

        // ================= STATE MANAGEMENT =================
        const STORE_KEY = 'cisaD1App_v11_perfect'; 
        
        function getInitialState() {
            return {
                masteredIds: [], 
                lostIds: [],     
                quickIds: [],    
                streak: { count: 0, lastDate: null },
                plan: {}, 
                stats: {
                    "Audit Charter & Mgmt": { correct: 0, total: 0 },
                    "Risk Assessment": { correct: 0, total: 0 },
                    "Audit Evidence & Sampling": { correct: 0, total: 0 },
                    "Internal Controls & CSA": { correct: 0, total: 0 },
                    "Reporting & Follow-up": { correct: 0, total: 0 }
                },
                errorLog: [],
                examDate: null
            };
        }

        let state = null;
        try {
            state = JSON.parse(localStorage.getItem(STORE_KEY));
        } catch(e) {
            console.error("Local storage error:", e);
        }

        if (!state || !state.stats || !state.masteredIds) {
            state = getInitialState();
        }

        // Engine State
        let currentQuiz = [];
        let currentQIndex = 0;
        let sessionScore = 0;
        let isExamMode = false;
        let selectedAnswerIndex = null;
        let examAnswers = []; 
        let timerInterval;
        let secondsElapsed = 0;
        let examTimeLimit = 90 * 60; // 90 mins
        let quickCurrentId = null;

        // ================= INIT =================
        function init() {
            checkStreak();
            renderDash();
            renderErrorLog();
            initQuickGrid();
        }

        function checkStreak() {
            const today = new Date().toLocaleDateString();
            if(state.streak.lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if(state.streak.lastDate === yesterday.toLocaleDateString() || state.streak.count === 0) {
                    // Valid continuation
                } else {
                    state.streak.count = 0; // Broke streak
                }
                const sc = document.getElementById('streak-count');
                if (sc) sc.textContent = state.streak.count;
            } else {
                const sc = document.getElementById('streak-count');
                if (sc) sc.textContent = state.streak.count;
            }
        }

        function incrementStreak() {
            const today = new Date().toLocaleDateString();
            if(state.streak.lastDate !== today) {
                state.streak.count += 1;
                state.streak.lastDate = today;
                const sc = document.getElementById('streak-count');
                if (sc) sc.textContent = state.streak.count;
                saveState();
                showToast("Daily Streak increased! 🔥");
            }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            const viewEl = document.getElementById(`view-${viewName}`);
            if (viewEl) viewEl.classList.add('active');
            
            const navEl = document.getElementById(`nav-${viewName}`);
            if (navEl) navEl.classList.add('active');
            
            if(viewName === 'dash') renderDash();
            if(viewName === 'review') renderErrorLog();
            if(viewName === 'quick') initQuickGrid();
            if(viewName === 'quiz') {
                const qMenu = document.getElementById('quiz-menu');
                if (qMenu) qMenu.style.display = 'block';
                const qEng = document.getElementById('quiz-engine');
                if (qEng) qEng.classList.remove('active');
                stopTimer();
            }
            
            const mainScroller = document.getElementById('main-scroll');
            if(mainScroller) mainScroller.scrollTo(0,0);
        }

        function saveState() { 
            try {
                localStorage.setItem(STORE_KEY, JSON.stringify(state)); 
            } catch(e) {
                console.error("Save error", e);
            }
        }

        // ================= UI HELPERS =================
        function showToast(msg) {
            const t = document.getElementById('toastContainer');
            if(!t) return;
            t.innerHTML = `<i class="fa-solid fa-bell"></i> <span>${msg}</span>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function haptic() { if(navigator.vibrate) navigator.vibrate(15); }

        // ================= DASHBOARD JOURNEY =================
        function renderDash() {
            try {
                const total = quizDB.length;
                const mastered = state.masteredIds.length;
                const lost = state.lostIds.length;
                const untouched = total - mastered - lost;
                
                const pct = total === 0 ? 0 : Math.round((mastered / total) * 100);
                
                const circle = document.getElementById('main-progress-ring');
                if (circle) {
                    const circumference = 400; 
                    const offset = circumference - (pct / 100) * circumference;
                    circle.style.strokeDashoffset = offset;
                }
                
                const dashPct = document.getElementById('dash-pct');
                if (dashPct) {
                    dashPct.textContent = `${pct}%`;
                    const colorClass = pct >= 80 ? 'var(--success)' : (pct >= 60 ? 'var(--warning)' : 'var(--danger)');
                    dashPct.style.color = colorClass;
                }

                const elMastered = document.getElementById('stat-mastered');
                if (elMastered) elMastered.textContent = mastered;
                const elLost = document.getElementById('stat-lost');
                if (elLost) elLost.textContent = lost;
                const elUntouched = document.getElementById('stat-untouched');
                if (elUntouched) elUntouched.textContent = untouched;

                const barMastered = document.getElementById('bar-mastered');
                if (barMastered) barMastered.style.width = `${(mastered/total)*100}%`;
                const barLost = document.getElementById('bar-lost');
                if (barLost) barLost.style.width = `${(lost/total)*100}%`;

                const statsContainer = document.getElementById('domain-stats');
                if (statsContainer) {
                    statsContainer.innerHTML = '';
                    d1Topics.forEach(topic => {
                        const stat = state.stats[topic] || {correct:0, total:0};
                        const topicPct = stat.total === 0 ? 0 : Math.round((stat.correct / stat.total) * 100);
                        let barColor = topicPct >= 80 ? 'var(--success)' : (topicPct >= 60 ? 'var(--warning)' : 'var(--danger)');
                        if(stat.total === 0) barColor = 'var(--text-muted)';
                        
                        statsContainer.innerHTML += `
                            <div class="progress-container">
                                <div class="progress-header">
                                    <span class="domain-name">${topic} <span class="domain-weight">${stat.total} Qs</span></span>
                                    <span style="color: ${barColor};">${topicPct}%</span>
                                </div>
                                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${topicPct}%; background: ${barColor}"></div></div>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                console.error("Safe renderDash failure:", err);
            }
        }

        // Bulletproof Reset Logic
        function hardReset() {
            if(confirm("DANGER: This wipes your entire journey, scores, and lost questions. Start fresh?")) {
                localStorage.removeItem(STORE_KEY);
                window.location.reload(); 
            }
        }

        // ================= TRACKING LOGIC (MASTERED VS LOST) =================
        function trackAnswer(id, isCorrect) {
            state.masteredIds = state.masteredIds.filter(x => x !== id);
            state.lostIds = state.lostIds.filter(x => x !== id);

            if(isCorrect) {
                state.masteredIds.push(id);
            } else {
                state.lostIds.push(id);
            }
            saveState();
        }

        // ================= QUICK GRIND =================
        function initQuickGrid() {
            const grid = document.getElementById('quick-grid');
            if (!grid) return;
            grid.innerHTML = '';
            quizDB.forEach((q, i) => {
                const el = document.createElement('div');
                let statusClass = '';
                if(state.masteredIds.includes(q.id)) statusClass = 'mastered';
                if(state.lostIds.includes(q.id)) statusClass = 'lost';
                
                el.className = `grid-item ${statusClass}`;
                el.innerText = i + 1;
                el.onclick = () => openQuickModal(q.id);
                grid.appendChild(el);
            });
        }

        function triggerQuickSpin() {
            const available = quizDB.filter(q => !state.masteredIds.includes(q.id));
            if(available.length === 0) {
                showToast("You mastered all 100 questions! Amazing job!");
                return;
            }
            
            const btn = document.getElementById('quickSpinBtn');
            if (btn) btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Selecting...`;
            
            let counter = 0, speed = 20, lastHighlight = null;
            const step = () => {
                if(lastHighlight) {
                    const oldEl = document.getElementById('quick-grid')?.children[lastHighlight.id-1];
                    if(oldEl) oldEl.classList.remove("highlight");
                }
                const randomItem = available[Math.floor(Math.random() * available.length)];
                const el = document.getElementById('quick-grid')?.children[randomItem.id-1];
                if(el) el.classList.add("highlight");
                lastHighlight = randomItem;
                playSound('tick');
                counter++;
                if(counter < 20) {
                    setTimeout(step, speed * 1.2);
                } else {
                    setTimeout(() => {
                        if(el) el.classList.remove("highlight"); 
                        openQuickModal(randomItem.id);
                        if (btn) btn.innerHTML = `<i class="fa-solid fa-dice"></i> Spin Random Unmastered`;
                    }, 400);
                }
            };
            step();
        }

        function openQuickModal(id) {
            haptic();
            quickCurrentId = id;
            const q = quizDB.find(x => x.id === id);
            if(!q) return;
            
            const tEl = document.getElementById('qm-topic');
            if(tEl) tEl.textContent = q.topic;
            
            const nEl = document.getElementById('qm-num');
            if(nEl) nEl.textContent = `Q #${id}`;
            
            const txtEl = document.getElementById('qm-text');
            if(txtEl) txtEl.innerHTML = q.q.replace(isacaKeywords, "<strong>$&</strong>");
            
            const optsContainer = document.getElementById('qm-options-container');
            if(optsContainer) {
                optsContainer.innerHTML = '';
                
                // Forced Attempts
                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerHTML = `<span class="option-letter">${['A','B','C','D'][idx]}</span> <span>${opt}</span>`;
                    btn.onclick = () => selectQuickAnswer(idx, btn);
                    optsContainer.appendChild(btn);
                });
            }
            
            const expContainer = document.getElementById('qm-exp');
            if(expContainer) expContainer.style.display = 'none';
            
            const doneBtn = document.getElementById('qm-done-btn');
            if(doneBtn) doneBtn.style.display = 'none';
            
            const overlay = document.getElementById('quickModalOverlay');
            if(overlay) overlay.classList.add('active');
        }

        function selectQuickAnswer(selectedIndex, btnElement) {
            haptic(); incrementStreak();
            const q = quizDB.find(x => x.id === quickCurrentId);
            if(!q) return;

            const isCorrect = (selectedIndex === q.a);
            
            if (isCorrect) {
                playSound('success');
                triggerConfetti();
            } else {
                playSound('wrong');
            }
            
            trackAnswer(q.id, isCorrect);

            const optsContainer = document.getElementById('qm-options-container');
            if(optsContainer) {
                const buttons = optsContainer.querySelectorAll('.option-btn');
                buttons.forEach((b, idx) => {
                    b.disabled = true;
                    if(idx === q.a) b.classList.add('correct');
                    else if (idx === selectedIndex && !isCorrect) b.classList.add('wrong');
                });
            }

            const expContainer = document.getElementById('qm-exp');
            if(expContainer) {
                expContainer.innerHTML = `
                    ${q.exp}
                    <div class="dynamic-rule"><i class="fa-solid fa-gavel"></i> <div><strong>ISACA Rule:</strong> ${q.rule}</div></div>
                    <div class="analogy-box"><i class="fa-solid fa-lightbulb"></i> <div><strong>Analogy:</strong> ${q.analogy}</div></div>
                `;
                expContainer.style.display = 'block';
            }
            
            const doneBtn = document.getElementById('qm-done-btn');
            if(doneBtn) doneBtn.style.display = 'flex';
        }

        function closeQuickModal(e) {
            const overlay = document.getElementById('quickModalOverlay');
            if(!overlay) return;
            if (!e || e.target === overlay) {
                overlay.classList.remove('active');
                initQuickGrid();
                renderDash();
            }
        }

        // ================= DEEP TRAIN (QUIZ ENGINE) =================
        function startQuiz(mode) {
            isExamMode = (mode === 'exam');
            examAnswers = [];
            
            if(mode === 'adaptive') {
                if(state.lostIds.length === 0) {
                    showToast("No Lost questions! Loading general practice.");
                    currentQuiz = [...quizDB].sort(()=>Math.random()-0.5).slice(0, 20);
                } else {
                    const pool = quizDB.filter(q => state.lostIds.includes(q.id));
                    currentQuiz = pool.sort(()=>Math.random()-0.5);
                }
            } else if (mode === 'practice') {
                currentQuiz = [...quizDB].sort(()=>Math.random()-0.5).slice(0, 20);
            } else if (mode === 'exam') {
                currentQuiz = [...quizDB].sort(()=>Math.random()-0.5); // All 100
            }

            currentQIndex = 0; sessionScore = 0;
            
            const qMenu = document.getElementById('quiz-menu');
            if(qMenu) qMenu.style.display = 'none';
            
            const qEng = document.getElementById('quiz-engine');
            if(qEng) qEng.classList.add('active');
            
            const timerEl = document.getElementById('session-timer');
            if(timerEl) {
                if(isExamMode) {
                    timerEl.classList.add('urgent');
                    startTimer(true); // 90 min countdown
                } else {
                    timerEl.classList.remove('urgent');
                    startTimer(false); // standard count-up
                }
            }
            
            loadQuestion();
        }

        function startTimer(countdown) {
            secondsElapsed = countdown ? examTimeLimit : 0;
            updateTimerUI();
            timerInterval = setInterval(() => {
                if(countdown) {
                    secondsElapsed--;
                    if(secondsElapsed <= 0) {
                        stopTimer();
                        alert("Time's up! Submitting exam automatically.");
                        finishQuiz();
                    }
                } else {
                    secondsElapsed++;
                }
                updateTimerUI();
            }, 1000);
        }

        function updateTimerUI() {
            let s = Math.max(0, secondsElapsed);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const sc = (s % 60).toString().padStart(2, '0');
            
            const tEl = document.getElementById('session-timer');
            if (!tEl) return;

            if (h > 0) {
                tEl.innerHTML = `<i class="fa-regular fa-clock"></i> ${h}:${m}:${sc}`;
            } else {
                tEl.innerHTML = `<i class="fa-regular fa-clock"></i> ${m}:${sc}`;
            }
        }

        function stopTimer() { clearInterval(timerInterval); }

        function loadQuestion() {
            selectedAnswerIndex = null; hasRevealed = false;
            
            const btnNext = document.getElementById('btn-next');
            if(btnNext) btnNext.style.display = 'none';
            
            const btnFinish = document.getElementById('btn-finish');
            if(btnFinish) btnFinish.style.display = 'none';
            
            const exp = document.getElementById('explanation');
            if(exp) exp.style.display = 'none';
            
            const q = currentQuiz[currentQIndex];
            if(!q) return;

            const qc = document.getElementById('quiz-counter');
            if(qc) qc.textContent = `${currentQIndex + 1} / ${currentQuiz.length}`;
            
            const qt = document.getElementById('quiz-topic');
            if(qt) qt.textContent = q.topic;
            
            const alertBox = document.getElementById('mindset-alert');
            if (alertBox) {
                if(!isExamMode && q.q.match(isacaKeywords)) {
                    alertBox.style.display = 'flex';
                    const kw = q.q.match(isacaKeywords)[0];
                    alertBox.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> <span>ISACA TRAP WORD: "<strong>${kw}</strong>"</span>`;
                } else {
                    alertBox.style.display = 'none';
                }
            }

            const qText = document.getElementById('q-text');
            if (qText) {
                let formattedQ = q.q.replace(isacaKeywords, "<strong style='color:var(--warning)'>$&</strong>");
                qText.innerHTML = formattedQ;
            }
            
            const optsContainer = document.getElementById('options-container');
            if (optsContainer) {
                optsContainer.innerHTML = '';
                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    if (isExamMode && examAnswers[currentQIndex] === idx) {
                        btn.classList.add('selected');
                    }
                    btn.innerHTML = `<span class="option-letter">${['A','B','C','D'][idx]}</span> <span>${opt}</span>`;
                    btn.onclick = () => handleOptionClick(idx, btn);
                    optsContainer.appendChild(btn);
                });
            }
        }

        function handleOptionClick(idx, btn) {
            haptic();
            selectedAnswerIndex = idx;
            
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            if(isExamMode) {
                // Do not grade instantly. Save choice, show Next/Finish button.
                examAnswers[currentQIndex] = idx;
                if(currentQIndex < currentQuiz.length - 1) {
                    const bN = document.getElementById('btn-next');
                    if(bN) bN.style.display = 'flex';
                } else {
                    const bF = document.getElementById('btn-finish');
                    if(bF) bF.style.display = 'flex';
                }
            } else {
                // Practice Mode: Grade instantly and show explanation
                buttons.forEach(b => b.disabled = true);
                processPracticeAnswer(idx);
            }
        }

        function processPracticeAnswer(idx) {
            incrementStreak();
            const q = currentQuiz[currentQIndex];
            if(!q) return;

            const isCorrect = (idx === q.a);
            
            if (isCorrect) {
                playSound('success');
                triggerConfetti();
            } else {
                playSound('wrong');
            }

            trackAnswer(q.id, isCorrect);
            
            if(!state.stats[q.topic]) state.stats[q.topic] = {correct:0, total:0};
            state.stats[q.topic].total += 1;

            if(isCorrect) {
                sessionScore++;
                state.stats[q.topic].correct += 1;
            } else {
                state.errorLog.unshift({
                    id: q.id, topic: q.topic, q: q.q, userAns: q.options[idx], corAns: q.options[q.a],
                    exp: q.exp, analogy: q.analogy, rule: q.rule, date: new Date().toLocaleDateString()
                });
                if(state.errorLog.length > 50) state.errorLog.pop();
            }
            saveState();

            const optsContainer = document.getElementById('options-container');
            if(optsContainer) {
                const buttons = optsContainer.querySelectorAll('.option-btn');
                buttons.forEach((b, i) => {
                    if(i === q.a) b.classList.add('correct');
                    else if (i === idx && !isCorrect) b.classList.add('wrong');
                });
            }

            const expBox = document.getElementById('explanation');
            if (expBox) {
                expBox.innerHTML = `
                    ${q.exp} 
                    <div class="dynamic-rule"><i class="fa-solid fa-gavel"></i> <div><strong>ISACA Rule:</strong> ${q.rule}</div></div>
                    <div class="analogy-box" style="margin-top: 12px;"><i class="fa-solid fa-lightbulb"></i> <div><strong>Analogy:</strong> ${q.analogy}</div></div>
                `;
                expBox.style.display = 'block';
            }

            if(currentQIndex < currentQuiz.length - 1) {
                const bN = document.getElementById('btn-next');
                if(bN) bN.style.display = 'flex';
            } else {
                const bF = document.getElementById('btn-finish');
                if(bF) bF.style.display = 'flex';
            }
            
            setTimeout(() => { 
                const ms = document.getElementById('main-scroll');
                if(ms) ms.scrollTo({top: 1000, behavior: 'smooth'}); 
            }, 100);
        }

        function nextQuestion() {
            if (isExamMode && selectedAnswerIndex !== null) {
                examAnswers[currentQIndex] = selectedAnswerIndex;
            }
            currentQIndex++;
            loadQuestion();
            const ms = document.getElementById('main-scroll');
            if(ms) ms.scrollTo(0,0);
        }

        function finishQuiz() {
            stopTimer();
            incrementStreak();
            
            if (isExamMode) {
                if (selectedAnswerIndex !== null) {
                    examAnswers[currentQIndex] = selectedAnswerIndex;
                }

                sessionScore = 0;
                currentQuiz.forEach((q, i) => {
                    const userAnsIdx = examAnswers[i];
                    const isCorrect = (userAnsIdx === q.a);
                    
                    if(!state.stats[q.topic]) state.stats[q.topic] = {correct:0, total:0};
                    state.stats[q.topic].total += 1;
                    
                    if (userAnsIdx !== undefined) {
                        trackAnswer(q.id, isCorrect);
                    }
                    
                    if (isCorrect) {
                        state.stats[q.topic].correct += 1;
                        sessionScore++;
                    } else {
                        state.errorLog.unshift({
                            id: q.id, topic: q.topic, q: q.q, 
                            userAns: userAnsIdx !== undefined ? q.options[userAnsIdx] : "Skipped", 
                            corAns: q.options[q.a],
                            exp: q.exp, analogy: q.analogy, rule: q.rule, date: new Date().toLocaleDateString()
                        });
                        if(state.errorLog.length > 100) state.errorLog.pop();
                    }
                });
                
                saveState();
                renderDash();
                const pct = Math.round((sessionScore / currentQuiz.length) * 100);
                
                if(pct >= 80) {
                    playSound('success');
                    triggerConfetti();
                }

                alert(`Exam Complete!\n\nScore: ${sessionScore} out of ${currentQuiz.length} (${pct}%)\n\nReview your mistakes in the Review tab.`);
                switchView('dash');

            } else {
                // Practice Finish
                renderDash();
                const pct = Math.round((sessionScore / currentQuiz.length) * 100);
                
                const tEl = document.getElementById('session-timer');
                let timeStr = tEl ? tEl.innerText : "Unknown";
                
                if(pct >= 80) {
                    playSound('success');
                    triggerConfetti();
                }
                
                alert(`Practice Session Complete!\n\nScore: ${pct}% (${sessionScore}/${currentQuiz.length})\nTime: ${timeStr}`);
                switchView('dash');
            }
        }

        // ================= ERROR LOG (REVIEW TAB) =================
        function renderErrorLog() {
            const list = document.getElementById('error-list');
            if(!list) return;
            list.innerHTML = '';
            
            if(state.lostIds.length === 0) {
                list.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px;">You haven't lost any questions yet! Good job!</p>`;
                return;
            }

            // Retrieve full question data for lost IDs
            const lostQs = quizDB.filter(q => state.lostIds.includes(q.id));

            lostQs.forEach(q => {
                list.innerHTML += `
                    <div class="error-card">
                        <div class="error-header">
                            <span style="color:var(--danger); font-weight:700; font-size:0.85rem;">Q #${q.id} | ${q.topic}</span>
                        </div>
                        <div class="err-q">${q.q.replace(isacaKeywords, "<strong>$&</strong>")}</div>
                        <div class="err-cor"><i class="fa-solid fa-check" style="width:15px"></i> Correct: ${q.options[q.a]}</div>
                        <div class="err-detailed-exp">
                            <p>${q.exp}</p>
                            <div class="analogy-box">
                                <i class="fa-solid fa-lightbulb"></i>
                                <div><strong>Analogy:</strong> ${q.analogy}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
